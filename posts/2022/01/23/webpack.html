<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    
    <title>Webpack | RunHio 的博客 ｜ RunHio Blog</title>
    <meta name="generator" content="VuePress 1.8.2">
    <link rel="icon" href="/favicon.ico">
    <meta name="description" content="个人博客">
    <meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
    
    <link rel="preload" href="/assets/css/0.styles.f77d8e52.css" as="style"><link rel="preload" href="/assets/js/app.70cbfe2c.js" as="script"><link rel="preload" href="/assets/js/6.1419a14d.js" as="script"><link rel="preload" href="/assets/js/37.05db4cc6.js" as="script"><link rel="prefetch" href="/assets/js/10.2e15052e.js"><link rel="prefetch" href="/assets/js/11.9760aa5a.js"><link rel="prefetch" href="/assets/js/12.5dd51cf0.js"><link rel="prefetch" href="/assets/js/13.9cea7209.js"><link rel="prefetch" href="/assets/js/14.a4892ffa.js"><link rel="prefetch" href="/assets/js/15.7e37fdbc.js"><link rel="prefetch" href="/assets/js/16.bfc00efe.js"><link rel="prefetch" href="/assets/js/17.42b751d4.js"><link rel="prefetch" href="/assets/js/18.7d94d9ca.js"><link rel="prefetch" href="/assets/js/19.5bf2dfa4.js"><link rel="prefetch" href="/assets/js/2.ffb60f29.js"><link rel="prefetch" href="/assets/js/20.76be16d6.js"><link rel="prefetch" href="/assets/js/21.d587942b.js"><link rel="prefetch" href="/assets/js/22.0c501fa3.js"><link rel="prefetch" href="/assets/js/23.23075f51.js"><link rel="prefetch" href="/assets/js/24.31b365c9.js"><link rel="prefetch" href="/assets/js/25.c0a22e47.js"><link rel="prefetch" href="/assets/js/26.eb0b9821.js"><link rel="prefetch" href="/assets/js/27.902f48f0.js"><link rel="prefetch" href="/assets/js/28.792bd15b.js"><link rel="prefetch" href="/assets/js/29.1fa1e936.js"><link rel="prefetch" href="/assets/js/3.95e33632.js"><link rel="prefetch" href="/assets/js/30.6289061a.js"><link rel="prefetch" href="/assets/js/31.4caa844a.js"><link rel="prefetch" href="/assets/js/32.469025af.js"><link rel="prefetch" href="/assets/js/33.6c8ad3f6.js"><link rel="prefetch" href="/assets/js/34.a6b6bcf1.js"><link rel="prefetch" href="/assets/js/35.3975429e.js"><link rel="prefetch" href="/assets/js/36.87997eee.js"><link rel="prefetch" href="/assets/js/38.8c5a7fbc.js"><link rel="prefetch" href="/assets/js/39.e0da8621.js"><link rel="prefetch" href="/assets/js/4.467972aa.js"><link rel="prefetch" href="/assets/js/40.647a3e55.js"><link rel="prefetch" href="/assets/js/41.98c93d10.js"><link rel="prefetch" href="/assets/js/5.963c915c.js"><link rel="prefetch" href="/assets/js/7.90b85d0e.js"><link rel="prefetch" href="/assets/js/8.2155397b.js"><link rel="prefetch" href="/assets/js/9.ac493e9a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f77d8e52.css">
    <meta id="referrer" name="referrer" content="never" />
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div id="global-layout" data-v-7f2e4136><header class="header-container" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/post-bg.jpeg);" data-v-93921ff8 data-v-7f2e4136><nav class="navbar" style="position:absolute;opacity:1;transition:all 0.5s ease-in-out;" data-v-93921ff8><a href="/" class="navbar-link router-link-active">
    RunHio'Blog
  </a> <ul class="navbar-links"><li><a href="/" class="router-link-active">
        HOME
      </a></li><li><a href="/about/">
        ABOUT
      </a></li><li><a href="/tags/">
        TAGS
      </a></li></ul> <div id="nav-icon"><span></span><span></span><span></span></div></nav> <div class="header-title" data-v-93921ff8 data-v-93921ff8><h1 data-v-93921ff8>Webpack</h1> <p data-v-93921ff8></p></div></header> <div class="container" data-v-b3fda33c data-v-7f2e4136><main class="main" style="width:60%;" data-v-b3fda33c><div class="post" data-v-b3fda33c data-v-b3fda33c><article class="main-div"><div class="post-content content content__default"><h2 id="模块化"><a href="#模块化" class="header-anchor">#</a> 模块化</h2> <h3 id="概念"><a href="#概念" class="header-anchor">#</a> 概念</h3> <p>将一个复杂的程序依据一定的规则,封装成几个块(文件),并进行组合在一起;</p> <p>块的内部数据和实现是私有的,只是向外部暴露了一些接口(方法)与外部其它模块通信</p> <h3 id="作用"><a href="#作用" class="header-anchor">#</a> 作用</h3> <p>在实际开发过程中,会遇到变量 函数 对象等名字的冲突,还可能会造成全局变量的污染</p> <p>所以模块化的作用有:</p> <ul><li><p>避免全局变量被污染</p></li> <li><p>便于代码编写和维护</p></li> <li><p>利于封装可重用逻辑</p></li></ul> <p>ES6之前,最主要是有**CommonJS和AMD/CMD.**前者用于服务器,后者用于浏览器.</p> <p>ES6在语言标准的层面上实现了模块功能,也就是**ESM,**成为浏览器和服务器通用的模块解决方案.</p> <h3 id="commonjs"><a href="#commonjs" class="header-anchor">#</a> CommonJS</h3> <p><code>Node.js</code>是commonjs规范的主要实践者,实际使用时,用<code>module.exports</code>定义当前模块对外输出的接口,用<code>require</code>加载模块</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 定义模块math.js</span>
<span class="token keyword">var</span> basicNum <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> <span class="token function">add</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token comment">//在这里写上需要向外暴露的函数、变量</span>
  add<span class="token operator">:</span> add<span class="token punctuation">,</span>
  basicNum<span class="token operator">:</span> basicNum
<span class="token punctuation">}</span>

<span class="token comment">// 引用自定义的模块时，参数包含路径，可省略.js</span>
<span class="token keyword">var</span> math <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./math'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
math<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 引用核心模块时，不需要带路径</span>
<span class="token keyword">var</span> http <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
http<span class="token punctuation">.</span><span class="token function">createService</span><span class="token punctuation">(</span><span class="token operator">...</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>CommonJS用同步的方式加载模块.</strong></p> <p><strong>在服务端,模块文件都存在本地磁盘,读取快速,但是在浏览器,限于网络原因,更合理的方案是使用异步加载</strong></p> <h4 id="module-exports和exports"><a href="#module-exports和exports" class="header-anchor">#</a> module.exports和exports</h4> <p>CommonJS规范仅定义了<code>exports</code>,但<code>exports</code>存在被重写而丢失的问题,所以创造了module.exports</p> <p>在CommonJS中,每个js文件都是一个模块,每个模块里都有一个全局module对象</p> <p><strong>这个module对象的exports属性用来导出接口.当外部模块导入当前模块时,使用的也是module对象.</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// hello.js</span>
<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">'hello world!'</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> s<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642747673614-0239e929-c9a8-4154-99b7-3cd19846d750.webp" alt="img"></p> <p>其他模块导入时</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// main.js</span>
<span class="token keyword">var</span> hello <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./hello.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello = hello world!</span>
</code></pre></div><p>当在hello.js中这样写时:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// hello.js</span>
<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">'hello world!'</span>
exports <span class="token operator">=</span> s<span class="token punctuation">;</span>
</code></pre></div><p>这里的exports被重写了</p> <p>更清除的代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">var</span> module <span class="token operator">=</span> <span class="token punctuation">{</span>
  exports<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">var</span> exports <span class="token operator">=</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports <span class="token operator">===</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span>

<span class="token keyword">var</span> s <span class="token operator">=</span> <span class="token string">'hello world!'</span>
exports <span class="token operator">=</span> s<span class="token punctuation">;</span> <span class="token comment">// module.exports 不受影响</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports <span class="token operator">===</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span>
</code></pre></div><ol><li>在模块初始化时,<code>exports</code>和<code>module.exports</code>指向同一块内存,因此有<code>exports===module.exports</code></li> <li>当<code>exports</code>被重新赋值时,重新指向了新的内存地址,切断了和原来内存地址的联系</li></ol> <p>exports的规范使用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// hello.js</span>
exports<span class="token punctuation">.</span>s <span class="token operator">=</span> <span class="token string">'hello world!'</span><span class="token punctuation">;</span>

<span class="token comment">// main.js</span>
<span class="token keyword">var</span> hello <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./hello.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>hello<span class="token punctuation">.</span>s<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// hello world!</span>
</code></pre></div><h4 id="特点"><a href="#特点" class="header-anchor">#</a> 特点</h4> <ul><li><p>所有代码都运行在模块作用域,不会污染全局作用域</p></li> <li><p>模块是同步加载的,即只有加载完毕,才能执行后面的操作</p></li> <li><p>模块在首次执行后就会缓存,再次加载只返回缓存结果</p></li> <li><p>CommonJS输出是值的拷贝,模块内部的变化不会影响导出的值</p></li></ul> <h3 id="amd和require-js"><a href="#amd和require-js" class="header-anchor">#</a> AMD和require.js</h3> <p>AMD规范采用异步方式加载模块,模块的加载不影响它后面语句的运行.</p> <p>所有依赖这个模块的语句,都定义在一个回调函数中,等到加载完毕之后这个回调才执行</p> <h4 id="requirejs用法"><a href="#requirejs用法" class="header-anchor">#</a> RequireJS用法</h4> <p>通过<code>define</code>来定义一个模块,使用<code>require</code>导入</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//a.js</span>
<span class="token comment">//define可以传入三个参数，分别是字符串-模块名、数组-依赖模块、函数-回调函数</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// b.js</span>
<span class="token comment">//数组中声明需要加载的模块，可以是模块名、js文件路径</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'a'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 1</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="特点-2"><a href="#特点-2" class="header-anchor">#</a> 特点</h4> <p>对于依赖的模块,AMD推崇**依赖前置,提前执行.**也就是在<code>define</code>方法里面传入的依赖模块,会在一开始就下载执行</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;e&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;f&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
    <span class="token comment">// 等于在最前面声明并初始化了要用到的所有模块</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 即便没用到某个模块 b，但 b 还是提前执行了</span>
      b<span class="token punctuation">.</span><span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="cmd和sea-js"><a href="#cmd和sea-js" class="header-anchor">#</a> CMD和sea.js</h3> <p>和require.js在声明依赖的模块时就直接初始化不一样,CMD推崇<strong>依赖就近,延迟执行</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">/** AMD写法 **/</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;b&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;c&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;d&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;e&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;f&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b<span class="token punctuation">,</span> c<span class="token punctuation">,</span> d<span class="token punctuation">,</span> e<span class="token punctuation">,</span> f</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> 
     <span class="token comment">// 等于在最前面声明并初始化了要用到的所有模块</span>
    a<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 即便没用到某个模块 b，但 b 还是提前执行了</span>
        b<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> 
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** CMD写法 **/</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//在需要时申明</span>
    a<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> b <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./b'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        b<span class="token punctuation">.</span><span class="token function">doSomething</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/** sea.js **/</span>
<span class="token comment">// 定义模块 math.js</span>
<span class="token function">define</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">require<span class="token punctuation">,</span> exports<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> $ <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jquery.js'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> <span class="token function-variable function">add</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span>b</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">return</span> a<span class="token operator">+</span>b<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    exports<span class="token punctuation">.</span>add <span class="token operator">=</span> add<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 加载模块</span>
seajs<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">'math.js'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">math</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">var</span> sum <span class="token operator">=</span> math<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token operator">+</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="esm"><a href="#esm" class="header-anchor">#</a> ESM</h3> <h4 id="特性"><a href="#特性" class="header-anchor">#</a> 特性</h4> <p>script标签执行时立即执行加载脚本， defer 属性会在页面渲染完之后执行脚本</p> <p>给script标签 设置type = module 来告知当前script标签中的代码采用ESM的规范来执行</p> <p>1.自动采用严格模式</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span><span class="token operator">&gt;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token comment">// undefined</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>2.每个EMS模块都是单独的私有作用域</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span><span class="token operator">&gt;</span>
    <span class="token keyword">var</span> a <span class="token operator">=</span> <span class="token number">111</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>

  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span><span class="token operator">&gt;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token comment">// ref Error</span>
  <span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><p>3.ESM的script标签会延迟执行脚本,默认加上了defer属性`</p> <p>4.ESM通过CORS跨域请求</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 下面地址去请求js库会报跨域，是因为这个地址不支持 <span class="token constant">CORS</span><span class="token punctuation">,</span> 如果要请求外部地址服务端必须支持 <span class="token constant">CORS</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;https://libs.baidu.com/jquery/2.0.0/jquery.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span><span class="token operator">!</span><span class="token operator">--</span> 下面这个地址就没有问题，因为服务端支持 <span class="token constant">CORS</span> <span class="token operator">--</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script type<span class="token operator">=</span><span class="token string">&quot;module&quot;</span> src<span class="token operator">=</span><span class="token string">&quot;https://unpkg.com/jquery@3.4.1/dist/jquery.min.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span><span class="token operator">/</span>script<span class="token operator">&gt;</span>
</code></pre></div><h4 id="export"><a href="#export" class="header-anchor">#</a> export</h4> <p><code>export</code>导出接口有以下方式</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// config.js</span>
<span class="token comment">// 直接导出</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> hello <span class="token operator">=</span> <span class="token string">'hello world!'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>

<span class="token comment">// 集中导出</span>
<span class="token keyword">const</span> hello <span class="token operator">=</span> <span class="token string">'hello world!'</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> api <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>prefix<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/api</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  hello<span class="token punctuation">,</span>
  api<span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面都是为了把hello和api分别导出</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// foo.js</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// 等同于：</span>
<span class="token keyword">function</span> <span class="token function">foo</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
  foo <span class="token keyword">as</span> <span class="token keyword">default</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>export default</code>用来导出模块的默认接口,它等同于导出一个名为<code>default</code>的接口.</p> <h4 id="import"><a href="#import" class="header-anchor">#</a> import</h4> <p>根据导出的方式,有相应的导入方式</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> api<span class="token punctuation">,</span> hello <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config.js'</span><span class="token punctuation">;</span>

<span class="token comment">// 配合`import`使用的`as`关键字用来为导入的接口重命名。</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> api <span class="token keyword">as</span> myApi <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./config.js'</span><span class="token punctuation">;</span>
</code></pre></div><p>对于<code>export default</code>导出的模块</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> foo <span class="token keyword">from</span> <span class="token string">'./foo.js'</span><span class="token punctuation">;</span>

<span class="token comment">// 等同于：</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> <span class="token keyword">default</span> <span class="token keyword">as</span> foo <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./foo.js'</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="esm和commonjs"><a href="#esm和commonjs" class="header-anchor">#</a> ESM和CommonJS</h3> <h4 id="输出拷贝和输出引用"><a href="#输出拷贝和输出引用" class="header-anchor">#</a> 输出拷贝和输出引用</h4> <p><strong>commonJS</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// a.js</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> <span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">,</span>
    b<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// main.js</span>
<span class="token comment">// node main.js</span>
<span class="token keyword">let</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./a'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// { num: 1 }</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// { num: 1 }</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>exports对象是模块内外的唯一关联,commonjs输出的内容,就是exports对象的属性,模块运行结束,属性就确定了</p> <p><strong>esm</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// a.mjs</span>
<span class="token keyword">let</span> a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">let</span> b <span class="token operator">=</span> <span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">1</span> <span class="token punctuation">}</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    a <span class="token operator">=</span> <span class="token number">2</span><span class="token punctuation">;</span>
    b <span class="token operator">=</span> <span class="token punctuation">{</span> num<span class="token operator">:</span> <span class="token number">2</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token punctuation">{</span>
    a<span class="token punctuation">,</span>
    b<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// main.mjs</span>
<span class="token comment">// node --experimental-modules main.mjs</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>a<span class="token punctuation">,</span> b<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./a'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 1</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// { num: 1 }</span>
<span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 2</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// { num: 2 }</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>模块内部引用的变化,会反应在外部</p> <h4 id="总结"><a href="#总结" class="header-anchor">#</a> 总结</h4> <p><strong>1. CommonJS 模块输出的是一个值的拷贝，ES6 模块输出的是值的引用。</strong></p> <ul><li>CommonJS 模块输出的是值的拷贝，也就是说，一旦输出一个值，模块内部的变化就影响不到这个值。</li> <li>ES6 模块的运行机制与 CommonJS 不一样。JS 引擎对脚本静态分析的时候，遇到模块加载命令<code>import</code>，就会生成一个只读引用。等到脚本真正执行时，再根据这个只读引用，到被加载的那个模块里面去取值。因此，ES6 模块是动态引用，并且不会缓存值，模块里面的变量绑定其所在的模块。</li></ul> <p><strong>2. CommonJS 模块是运行时加载，ES6 模块是编译时输出接口。</strong></p> <ul><li>运行时加载: CommonJS 模块就是对象；即在输入时是先加载整个模块，生成一个对象，然后再从这个对象上面读取方法，这种加载称为“运行时加载”。</li> <li>编译时加载: ES6 模块不是对象，而是通过<code>export</code> 命令显式指定输出的代码，<code>import</code>时采用静态命令的形式。即在<code>import</code>时可以指定加载某个输出值，而不是加载整个模块，这种加载称为“编译时加载”。</li></ul> <h2 id="基础配置"><a href="#基础配置" class="header-anchor">#</a> 基础配置</h2> <h3 id="简单配置"><a href="#简单配置" class="header-anchor">#</a> 简单配置</h3> <h4 id="依赖安装"><a href="#依赖安装" class="header-anchor">#</a> 依赖安装</h4> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> webpack webpack-cli -D
</code></pre></div><h4 id="工作模式"><a href="#工作模式" class="header-anchor">#</a> 工作模式</h4> <p>新建 ./src/index.js 文件，编写简单代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token string">'Hello ITEM'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> a<span class="token punctuation">;</span>
</code></pre></div><p>此时目录结构</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>webpack_work                  
├─ src                
│  └─ index<span class="token punctuation">.</span>js         
└─ <span class="token keyword">package</span><span class="token punctuation">.</span>json       
</code></pre></div><p>运行npx webpack</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642401128614-ba7ac817-8098-4760-aeda-c75028ae929c.webp" alt="img"></p> <p>提示未进行mode（模式）配置</p> <p>模式：供mode配置选项，告知webpack使用相应模式的内置优化，默认值为<code>production</code>，另外还有<code>development``none</code></p> <ul><li><p><code>production</code>：开发模式，打包更加快速，省略了代码优化的阶段</p></li> <li><p><code>development</code>：生产模式，打包速度慢，会开启tree-shaking和压缩代码</p></li> <li><p><code>none</code>：不适用任何默认优化选项</p></li></ul> <p>在配置对象中加入下列配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>或者在cli参数中传递</p> <div class="language-shell extra-class"><pre class="language-shell"><code>webpack --mode<span class="token operator">=</span>development
</code></pre></div><h4 id="配置文件"><a href="#配置文件" class="header-anchor">#</a> 配置文件</h4> <p>在根路径下新建一个配置文件webpack.config.js，编写基本配置信息</p> <div class="language-shell extra-class"><pre class="language-shell"><code>const path <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

module.exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode: <span class="token string">'development'</span>, // 模式
  entry: <span class="token string">'./src/index.js'</span>, // 打包入口地址
  output: <span class="token punctuation">{</span>
    filename: <span class="token string">'bundle.js'</span>, // 输出文件名
    path: path.join<span class="token punctuation">(</span>__dirname, <span class="token string">'dist'</span><span class="token punctuation">)</span> // 输出文件目录
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="loader"><a href="#loader" class="header-anchor">#</a> Loader</h4> <p>新增CSS文件</p> <div class="language-css extra-class"><pre class="language-css"><code><span class="token selector">body</span> <span class="token punctuation">{</span>
  <span class="token property">margin</span><span class="token punctuation">:</span> 0 auto<span class="token punctuation">;</span>
  <span class="token property">padding</span><span class="token punctuation">:</span> 0 20px<span class="token punctuation">;</span>
  <span class="token property">max-width</span><span class="token punctuation">:</span> 800px<span class="token punctuation">;</span>
  <span class="token property">background</span><span class="token punctuation">:</span> #f4f8fb<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>修改配置文件中的入口文件为新的CSS文件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token comment">// 模式</span>
  entry<span class="token operator">:</span> <span class="token string">'./src/main.css'</span><span class="token punctuation">,</span> <span class="token comment">// 打包入口地址</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">'bundle.css'</span><span class="token punctuation">,</span> <span class="token comment">// 输出文件名</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span> <span class="token comment">// 输出文件目录</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>打包之后会发现不成功</p> <p>因为<strong>webpack默认支持处理JS与JSON文件，其他类型处理不了，这里必须借助Loader来对不同类型的文件进行处理。</strong></p> <p>安装对应的loader来处理CSS</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> css-loader
</code></pre></div><p>配置文件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token comment">// 模式</span>
  entry<span class="token operator">:</span> <span class="token string">'./src/main.css'</span><span class="token punctuation">,</span> <span class="token comment">// 打包入口地址</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">'bundle.css'</span><span class="token punctuation">,</span> <span class="token comment">// 输出文件名</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span> <span class="token comment">// 输出文件目录</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span> 
    rules<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token comment">// 转换规则</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">//匹配所有的 css 文件</span>
        use<span class="token operator">:</span> <span class="token string">'css-loader'</span> <span class="token comment">// use: 对应的 Loader 名称</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再次运行可以打包成功</p> <p><strong>结论：Loader就是将Webpack不认识的内容转化为认识的内容</strong></p> <h4 id="plugin"><a href="#plugin" class="header-anchor">#</a> Plugin</h4> <p>与loader用于转换特定类型的文件不同，<strong>Plugin可以贯穿Webpack打包的生命周期，执行不同的任务</strong></p> <p>例如，希望js或css文件可以自动引入到Html中，就需要使用插件<code>html-webpack-plugin</code></p> <p>新建<code>src/index.html</code></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token doctype"><span class="token punctuation">&lt;!</span><span class="token doctype-tag">DOCTYPE</span> <span class="token name">html</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>html</span> <span class="token attr-name">lang</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>en<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">charset</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>UTF-8<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">http-equiv</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>X-UA-Compatible<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>IE=edge<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>meta</span> <span class="token attr-name">name</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>viewport<span class="token punctuation">&quot;</span></span> <span class="token attr-name">content</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>width=device-width, initial-scale=1.0<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>title</span><span class="token punctuation">&gt;</span></span>ITEM<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>title</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
  
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>html</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>安装插件</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> html-webpack-plugin
</code></pre></div><p>配置插件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> HtmlWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'html-webpack-plugin'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span> <span class="token comment">// 模式</span>
  entry<span class="token operator">:</span> <span class="token string">'./src/index.js'</span><span class="token punctuation">,</span> <span class="token comment">// 打包入口地址</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    filename<span class="token operator">:</span> <span class="token string">'bundle.js'</span><span class="token punctuation">,</span> <span class="token comment">// 输出文件名</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'dist'</span><span class="token punctuation">)</span> <span class="token comment">// 输出文件目录</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span> 
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">//匹配所有的 css 文件</span>
        use<span class="token operator">:</span> <span class="token string">'css-loader'</span> <span class="token comment">// use: 对应的 Loader 名称</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span><span class="token punctuation">[</span> <span class="token comment">// 配置插件</span>
    <span class="token keyword">new</span> <span class="token class-name">HtmlWebpackPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      template<span class="token operator">:</span> <span class="token string">'./src/index.html'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行打包命令后可以看到dist目录下生成的index.html中已经引入了js文件</p> <h4 id="自动清空打包目录"><a href="#自动清空打包目录" class="header-anchor">#</a> 自动清空打包目录</h4> <p>每次打包时，打包目录都会遗留上次打包的文件，为了保持打包目录的纯净，需要在打包前将打包目录清空</p> <p>可以使用<code>clean-webpack-plugin</code>插件实现</p> <h4 id="区分环境"><a href="#区分环境" class="header-anchor">#</a> 区分环境</h4> <p><strong>本地环境：</strong></p> <ul><li><p><strong>需要更快的构建速度</strong></p></li> <li><p><strong>需要打印debug信息</strong></p></li> <li><p><strong>需要hot reload功能</strong></p></li> <li><p><strong>需要sourcemap方便定位问题</strong></p></li></ul> <p><strong>生产环境：</strong></p> <ul><li><p><strong>需要更小的包体积，代码压缩+tree-shaking</strong></p></li> <li><p><strong>需要进行代码分割</strong></p></li> <li><p><strong>需要压缩图片体积</strong></p></li></ul> <p>针对不对需求，首先要做的就是做好环境区分</p> <p>安装<code>cross-env</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> cross-env -D
</code></pre></div><p>配置启动命令</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=dev webpack serve --mode development&quot;</span><span class="token punctuation">,</span> 
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=test webpack --mode production&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=prod webpack --mode production&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h4 id="启动devserver"><a href="#启动devserver" class="header-anchor">#</a> 启动devServer</h4> <p>安装<code>webpack-dev-server</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> intall webpack-dev-server@3.11.2 -D
</code></pre></div><p>webpack版本大于4之后需要用devServer.static进行配置，不再有devServer.contentBase选项</p> <p>配置本地服务</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>
<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
    contentBase<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'public'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// 静态文件目录</span>
    compress<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">//是否启动压缩 gzip</span>
    port<span class="token operator">:</span> <span class="token number">8080</span><span class="token punctuation">,</span> <span class="token comment">// 端口号</span>
    <span class="token comment">// open:true  // 是否自动打开浏览器</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>contentBase:</strong></p> <p><strong>因为在webpack打包时，对静态文件的处理，例如图片都是直接copy到dist目录下的。但是对于本地开发来说这个过程太费时，所以在设置了contentBase之后就直接到对应的静态目录下去读取文件，不需要对文件进行迁移</strong></p> <p>执行命令就可以启动服务</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> run dev
</code></pre></div><h4 id="引入css"><a href="#引入css" class="header-anchor">#</a> 引入CSS</h4> <p>单靠一个css-loader是没有方法将样式加载到页面上的，这个时候需要安装style-loader</p> <p><code>style-loader</code>的作用是把处理好的css通过style标签的形式添加到页面上</p> <p>安装依赖</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> style-loader
</code></pre></div><p>配置loader</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span> 
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">//匹配所有的 css 文件</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'style-loader'</span><span class="token punctuation">,</span><span class="token string">'css-loader'</span><span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Loader的执行顺序是固定从后往前的，即按css-loader --&gt; style-loader</p> <p>在入口文件中引入样式文件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// ./src/index.js</span>

<span class="token keyword">import</span> <span class="token string">'./main.css'</span><span class="token punctuation">;</span>


<span class="token keyword">const</span> a <span class="token operator">=</span> <span class="token string">'Hello ITEM'</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> a<span class="token punctuation">;</span>
</code></pre></div><p>重新启动一下服务，可以看到样式已经通过style标签插入到了html中</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642403885197-836c4261-cdd9-48ab-8436-06ef0480defb.webp" alt="img"></p> <p><code>style-loader</code>的核心逻辑相当于</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> content <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>样式内容<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token keyword">const</span> style <span class="token operator">=</span> document<span class="token punctuation">.</span><span class="token function">createElement</span><span class="token punctuation">(</span><span class="token string">'style'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
style<span class="token punctuation">.</span>innerHTML <span class="token operator">=</span> content<span class="token punctuation">;</span>
document<span class="token punctuation">.</span>head<span class="token punctuation">.</span><span class="token function">appendChild</span><span class="token punctuation">(</span>style<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="css兼容性"><a href="#css兼容性" class="header-anchor">#</a> CSS兼容性</h4> <p>可以使用<code>postcss-loader</code>，自动添加部分属性的浏览器前缀</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> postcss postcss-loader postcss-preset-env -D
const config <span class="token operator">=</span> <span class="token punctuation">{</span>
  // <span class="token punctuation">..</span>.
  module: <span class="token punctuation">{</span> 
    rules: <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test: /<span class="token punctuation">\</span>.css$/, //匹配所有的 css 文件
        use: <span class="token punctuation">[</span>
          <span class="token string">'style-loader'</span>,
          <span class="token string">'css-loader'</span>, 
          <span class="token string">'postcss-loader'</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>, 
  // <span class="token punctuation">..</span>.
<span class="token punctuation">}</span>
</code></pre></div><p>添加postcss的配置文件<code>postcss.config.js</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// postcss.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'postcss-preset-env'</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>创建postcss-preset-env的配置文件<code>.browserslistrc</code></p> <div class="language-plain extra-class"><pre class="language-plain"><code># 换行相当于 and
last 2 versions # 回退两个浏览器版本
&gt; 0.5% # 全球超过0.5%人使用的浏览器，可以通过 caniuse.com 查看不同浏览器不同版本占有率
IE 10 # 兼容IE 10
</code></pre></div><p>运行</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642404176358-90bfea3d-344d-4ef0-abdd-df0b3a9f63f2.webp" alt="img"></p> <p>autoprefixer在线转化器：http://autoprefixer.github.io/</p> <h4 id="分离样式文件"><a href="#分离样式文件" class="header-anchor">#</a> 分离样式文件</h4> <p>如果不想要样式文件通过<code>style</code>标签引入，可以进行文件形式的引入</p> <p>安装<code>mini-css-extract-plugin</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> mini-css-extract-plugin
</code></pre></div><p>修改配置，记得去掉先前的<code>style-loader</code>，因为它是标签形式引入的</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// ...</span>
<span class="token comment">// 引入插件</span>
<span class="token keyword">const</span> MiniCssExtractPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'mini-css-extract-plugin'</span><span class="token punctuation">)</span>


<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span> 
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// ...</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(s[ac]|c)ss$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span> <span class="token comment">//匹配所有的 sass/scss/css 文件</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token comment">// 'style-loader',</span>
          MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token comment">// 添加 loader</span>
          <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'sass-loader'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">]</span> 
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
  plugins<span class="token operator">:</span><span class="token punctuation">[</span> <span class="token comment">// 配置插件</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token comment">// 添加插件</span>
      filename<span class="token operator">:</span> <span class="token string">'[name].[hash:8].css'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>
</code></pre></div><p>打包结果</p> <div class="language-plain extra-class"><pre class="language-plain"><code>dist                     
├─ bundle.js            
├─ index.html              
└─ main.3bcbae64.css # 生成的样式文件  
</code></pre></div><p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642404511092-d7439ba0-f7c2-4ba5-832b-90bbc360d3ff.webp" alt="img"></p> <h4 id="sourcemap"><a href="#sourcemap" class="header-anchor">#</a> sourceMap</h4> <p><code>sourceMap</code>就是一个信息文件，里面存储了代码打包转换后的位置信息，实质上是一个json描述文件，维护了打包前后的代码映射关系。</p> <p>常见的源码转换主要是以下三种情况：</p> <ul><li><p>压缩减小体积</p></li> <li><p>多个文件合并,减少http请求数</p></li> <li><p>其他语言编译成JavaScript</p></li></ul> <p>转换后的实际运行代码不同于开发代码,debug变得困难,所以才需要sourceMap.</p> <p>例如用webpack打包编译下面这段代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'source map!!!'</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//这一行肯定会报错</span>
</code></pre></div><p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642407342854-62c73f09-72cc-4fc4-8553-6705716eb1a6.webp" alt="img"></p> <p>点击进入报错文件之后</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642407358676-8183d3fd-3ea9-4f04-b73e-c0e17f797d16.webp" alt="img"></p> <p>无法定位到具体位置.</p> <p>于是在webpack配置中开启sourceMap</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642407385877-84405383-182c-44ca-870f-8f49cf5f49f0.webp" alt="img"></p> <p>重新构建后打开浏览器</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642407401917-082009ef-c5f8-4bf7-94fa-8647298e0d3f.webp" alt="img"></p> <p>可以定位到具体的错误位置.</p> <h4 id="文件指纹"><a href="#文件指纹" class="header-anchor">#</a> 文件指纹</h4> <p>Webpack的文件指纹是指文件名后面加上hash值,作用是为了缓存</p> <p>例如在基础配置中用到的:<code>filename:&quot;[name][hash:8][ext]&quot;</code></p> <ul><li><p>ext:文件后缀名</p></li> <li><p>name:文件名</p></li> <li><p>path:文件相对路径</p></li> <li><p>folder:文件所在文件夹</p></li> <li><p>hash:每次构建生成的唯一 hash 值</p></li> <li><p>chunkhash:根据 chunk 生成 hash 值</p></li> <li><p>contenthash:根据文件内容生成hash 值</p></li></ul> <p><strong>hash:任何一个文件改动,整个项目的构建hash值都会变</strong></p> <p><strong>chunkhash:文件的改动只会影响其所在chunk的hash值</strong></p> <p><strong>contenthash:每个文件都有独立的hash值,文件的改动只影响自身的hash值</strong></p> <p><strong>js的文件指纹</strong></p> <p>设置output的filename,用chunkhash</p> <p><strong>css的文件指纹</strong></p> <p>设置minicssextractPlugin的filename,用contenthash</p> <h3 id="优化构建速度"><a href="#优化构建速度" class="header-anchor">#</a> 优化构建速度</h3> <h4 id="简化模块引用"><a href="#简化模块引用" class="header-anchor">#</a> 简化模块引用</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token operator">...</span>
<span class="token comment">// 路径处理方法</span>
<span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

 <span class="token keyword">const</span> config  <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token operator">...</span>
  resolve<span class="token operator">:</span><span class="token punctuation">{</span>
    <span class="token comment">// 配置别名</span>
    alias<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token string">'~'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'@'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token string">'components'</span><span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src/components'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>配置完成之后,可以在项目中使用别名</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 使用 src 别名 ~ </span>
<span class="token keyword">import</span> <span class="token string">'~/fonts/iconfont.css'</span>

<span class="token comment">// 使用 src 别名 @ </span>
<span class="token keyword">import</span> <span class="token string">'@/fonts/iconfont.css'</span>

<span class="token comment">// 使用 components 别名</span>
<span class="token keyword">import</span> footer <span class="token keyword">from</span> <span class="token string">&quot;components/footer&quot;</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="多进程配置"><a href="#多进程配置" class="header-anchor">#</a> 多进程配置</h4> <p>小型项目一般不用,因为启动进程和进程通信都有一定开销</p> <p>安装<code>thread-loader</code></p> <p>配置在<code>thread-loader</code>之后的loader都会在一个单独的worker池中运行</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i -D thread-loader
</code></pre></div><p>配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 路径处理方法</span>
<span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">//...</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span> 
    noParse<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">jquery|lodash</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        include<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token punctuation">{</span>
            loader<span class="token operator">:</span> <span class="token string">'thread-loader'</span><span class="token punctuation">,</span> <span class="token comment">// 开启多进程打包</span>
            options<span class="token operator">:</span> <span class="token punctuation">{</span>
              worker<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="缓存"><a href="#缓存" class="header-anchor">#</a> 缓存</h4> <p>利用缓存可以大幅提升重复构建的速度</p> <p><strong>babel-loader开启缓存</strong></p> <ul><li><strong>babel在转译js过程中时间开销比较大,将babel-loader的执行结果缓存起来,重新打包时直接读取缓存</strong></li> <li><strong>缓存位置:</strong><code>node_modules/.cache/babel-loader</code></li></ul> <p>配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
 module<span class="token operator">:</span> <span class="token punctuation">{</span> 
    noParse<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">jquery|lodash</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span>
        include<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        exclude<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">node_modules</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token comment">// ...</span>
          <span class="token punctuation">{</span>
            loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span><span class="token punctuation">,</span>
            options<span class="token operator">:</span> <span class="token punctuation">{</span>
              cacheDirectory<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 启用缓存</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// ...</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>cache-loader</strong></p> <ul><li><strong>缓存一些性能开销比较大的loader处理结果</strong></li></ul> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i -D cache-loader
</code></pre></div><p>配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
 module<span class="token operator">:</span> <span class="token punctuation">{</span> 
    <span class="token comment">// ...</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(s[ac]|c)ss$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">i</span></span><span class="token punctuation">,</span> <span class="token comment">//匹配所有的 sass/scss/css 文件</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token comment">// 'style-loader',</span>
          MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span>
          <span class="token string">'cache-loader'</span><span class="token punctuation">,</span> <span class="token comment">// 获取前面 loader 转换的结果</span>
          <span class="token string">'css-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'postcss-loader'</span><span class="token punctuation">,</span>
          <span class="token string">'sass-loader'</span><span class="token punctuation">,</span> 
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> 
      <span class="token comment">// ...</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="dllplugin"><a href="#dllplugin" class="header-anchor">#</a> DLLPlugin</h4> <p><strong>DLLPlugin可以打包常用的且不经常更新的模块,生成JS和json文件,一般放进public目录中,项目打包时不会再对这些依赖进行编译,而是通过在html中插入script标签来读取.</strong></p> <p>比如vue,echarts等常用框架和资源库,这些项目依赖包达到一定规模时速度的提升尤为明显.</p> <p>详情使用可参考:https://juejin.cn/post/6915028318900125703#heading-13</p> <p>个人认为可以用<strong>externals</strong>代替</p> <h4 id="code-splite"><a href="#code-splite" class="header-anchor">#</a> Code Splite</h4> <p><strong>分析</strong></p> <p><code>webpack</code>默认配置下会把所有的依赖和插件都打包到<code>vendors.js</code>中.所以对于大量引入第三方依赖的项目,这个文件会非常大.所以它会带来以下的问题:</p> <ul><li>打包文件很大,首屏加载时间长</li> <li>第三方库,一般不会改动,但是我们的业务代码是经常需要改动的,假设我改动了业务逻辑接着重新打包,这个时候会重新生成一个大的文件</li></ul> <p><strong>解决</strong></p> <p>第三方库可以打包到另一个文件中</p> <ul><li>业务代码放到<code>main.js</code>中</li> <li><code>vendors~main.js</code>放第三方库</li></ul> <p>这里采用<code>Code Splitting</code>代码分割</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
        splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
            chunks<span class="token operator">:</span> <span class="token string">'all'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>配置</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>splitChunks<span class="token operator">:</span> <span class="token punctuation">{</span>
    chunks<span class="token operator">:</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">,</span>
    minSize<span class="token operator">:</span> <span class="token number">30000</span><span class="token punctuation">,</span>
    maxSize<span class="token operator">:</span> <span class="token number">50000</span><span class="token punctuation">,</span>
    minChunks<span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    maxAsyncRequests<span class="token operator">:</span> <span class="token number">5</span><span class="token punctuation">,</span>
    maxInitialRequests<span class="token operator">:</span> <span class="token number">3</span><span class="token punctuation">,</span>
    automaticNameDelimiter<span class="token operator">:</span> <span class="token string">'~'</span><span class="token punctuation">,</span>
    name<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    cacheGroups<span class="token operator">:</span> <span class="token punctuation">{</span>
        vendors<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token comment">// 引入的库是否在node_modules里</span>
            test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">[\\/]node_modules[\\/]</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
            priority<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">10</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token keyword">default</span><span class="token operator">:</span> <span class="token punctuation">{</span>
                minChunks<span class="token operator">:</span> <span class="token number">2</span><span class="token punctuation">,</span>
                priority<span class="token operator">:</span> <span class="token operator">-</span><span class="token number">20</span><span class="token punctuation">,</span>
                reuseExistingChunk<span class="token operator">:</span> <span class="token boolean">true</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ul><li><p>chunks的意思是对那些类型的代码进行分割，all是全部、async是异步、initial是同步;</p></li> <li><p>minSize的意思是引入的模块必须大于30kb，才会进行代码分割；</p></li> <li><p>maxSize的意思是如果引入的模块，如果大于50kb，进行二次分割，分成多个文件；</p></li> <li><p>minChunks当模块引入次数大于1时，才会进行代码分割；</p></li> <li><p>maxAsyncRequests同时加载5个以上的js文件，并行请求的最大数目为5；</p></li> <li><p>maxInitialRequests 入口文件中，如果加载的模块大于3个时，不再进行代码分割；</p></li> <li><p>automaticNameDelimiter表示拆分出的chunk的名称连接符。默认为~。如vendors~main.js;</p></li> <li><p>name 可重新定义打包后的文件名称，cacheGroups的vendors的filename生效;</p></li> <li><p>priority当一个文件的打包条件同时满足vendors以及default中的条件时,会根据priority的大小优先选择应用那个，数值越大优先级越高；</p></li> <li><p>reuseExistingChunk如果a模块引用的模块b已经打包过，再打包时b模块不再进行打包，直接使用;</p></li></ul> <h3 id="优化构建结果"><a href="#优化构建结果" class="header-anchor">#</a> 优化构建结果</h3> <h4 id="构建结果分析"><a href="#构建结果分析" class="header-anchor">#</a> 构建结果分析</h4> <p>借助插件<code>webpack-bundle-analyzer</code>可以直观看到打包结果中的文件体积大小和各模块的依赖关系</p> <p>安装</p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i -D webpack-bundle-analyzer
</code></pre></div><p>配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 引入插件</span>
<span class="token keyword">const</span> BundleAnalyzerPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-bundle-analyzer'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>BundleAnalyzerPlugin


<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  plugins<span class="token operator">:</span><span class="token punctuation">[</span> 
    <span class="token comment">// ...</span>
    <span class="token comment">// 配置插件 </span>
    <span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      <span class="token comment">// analyzerMode: 'disabled',  // 不启动展示打包报告的http服务器</span>
      <span class="token comment">// generateStatsFile: true, // 是否生成stats.json文件</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>启动命令</p> <div class="language-json extra-class"><pre class="language-json"><code> <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token property">&quot;analyzer&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cross-env NODE_ENV=prod webpack --progress --mode production&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>执行命令之后访问端口为8888的地址可以看到</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642408765804-1350a1a4-763e-4712-b3ef-ba95c4f75734.webp" alt="img"></p> <p>如果不想启动web服务</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">BundleAnalyzerPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
   analyzerMode<span class="token operator">:</span> <span class="token string">'disabled'</span><span class="token punctuation">,</span>  <span class="token comment">// 不启动展示打包报告的http服务器</span>
   generateStatsFile<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 是否生成stats.json文件</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><h4 id="压缩css"><a href="#压缩css" class="header-anchor">#</a> 压缩CSS</h4> <p>安装<code>optimize-css-assets-webpack-plugin</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> <span class="token function">install</span> -D optimize-css-assets-webpack-plugin 
</code></pre></div><p>修改配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// ...</span>
<span class="token comment">// 压缩css</span>
<span class="token keyword">const</span> OptimizeCssAssetsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'optimize-css-assets-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token comment">// ...</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    minimize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    minimizer<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// 添加 css 压缩配置</span>
      <span class="token keyword">new</span> <span class="token class-name">OptimizeCssAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
 <span class="token comment">// ...</span>
<span class="token punctuation">}</span>

<span class="token comment">// ...</span>
</code></pre></div><p>打包结果</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642408897426-ac046283-11a7-423a-b8cf-660122517982.webp" alt="img"></p> <h4 id="压缩js"><a href="#压缩js" class="header-anchor">#</a> 压缩JS</h4> <p>在生产环境下默认会开启js压缩,但是我们手动配置<code>optimization</code>选项之后,就不再默认对js进行压缩,需要手动配置</p> <p>因为webapck5中内置了<code>terser-webpack-plugin</code>,所以直接引用</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> TerserPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'terser-webpack-plugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    minimize<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 开启最小化</span>
    minimizer<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// ...</span>
      <span class="token keyword">new</span> <span class="token class-name">TerserPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="清除无用的css"><a href="#清除无用的css" class="header-anchor">#</a> 清除无用的CSS</h4> <p>安装插件<code>purgecss-webpack-plugin</code></p> <div class="language-shell extra-class"><pre class="language-shell"><code><span class="token function">npm</span> i -D purgecss-webpack-plugin
</code></pre></div><p>添加配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// ...</span>
<span class="token keyword">const</span> PurgecssWebpackPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'purgecss-webpack-plugin'</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> glob <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'glob'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 文件匹配模式</span>
<span class="token comment">// ...</span>

<span class="token keyword">function</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token parameter">dir</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
  <span class="token keyword">return</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> dir<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> <span class="token constant">PATHS</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  src<span class="token operator">:</span> <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'src'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">const</span> config <span class="token operator">=</span> <span class="token punctuation">{</span>
  plugins<span class="token operator">:</span><span class="token punctuation">[</span> <span class="token comment">// 配置插件</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">new</span> <span class="token class-name">PurgecssPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      paths<span class="token operator">:</span> glob<span class="token punctuation">.</span><span class="token function">sync</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">PATHS</span><span class="token punctuation">.</span>src<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/**/*</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token punctuation">{</span>nodir<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>再次打包会把没用到的css样式自动去除,不再打包进最终的文件中</p> <h4 id="externals"><a href="#externals" class="header-anchor">#</a> Externals</h4> <p>将第三方的类库放到CDN上,能够大幅度减少生产环境中的项目体积,另外CDN能够实时地根据网络流量和各节点的连接 负载状况以及到用户的距离和响应时间等综合信息将用户的请求重新导向离用户最近的服务节点上</p> <p>另外因为CDN和服务器的域名一般不是同一个,可以缓解同一域名并非http请求的数量限制,有效分流以及减少多余的cookie发送</p> <hr> <p>Vue在使用webpack构建之后,<code>chunk-vendors.js</code>这个文件巨大无比,加载时间长,这是首屏加载时间长的罪魁祸首之一</p> <p>首先通过插件<code>webpack-bundle-analyzer</code>查看chunk-vendors.js的文件内容</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642413029190-e439fbd0-3ff9-468d-8d45-022c3804d923.webp" alt="img"></p> <p>从上面的依赖图可以看到,最大的两个js文件里面都是一些第三方的依赖包,那么只要把这些依赖包提取即可.</p> <p><strong>externals就可以用来防止这些依赖包被打包</strong></p> <p><code>externals</code>的值是个对象</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    <span class="token function-variable function">configureWebpack</span><span class="token operator">:</span><span class="token parameter">congig</span> <span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        externals<span class="token operator">:</span><span class="token punctuation">{</span>
            key<span class="token operator">:</span> value
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中<code>key</code>是第三方依赖库的名称,同<code>package.json</code>文件中的<code>dependcies</code>对象的key一样</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642413165342-f0b0d36c-0657-4b53-89d6-3d5d619eb4af.webp" alt="img"></p> <p>value值是<strong>第三方依赖编译打包后生成的js文件,然后js文件执行后赋值给window的全局变量名称</strong></p> <p><strong>例:</strong></p> <p>在public/index.html中用cdn引入各需要剥离的依赖</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.runtime.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/vue-router/3.2.0/vue-router.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/element-ui@2.10.1/lib/index.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/xlsx/0.16.1/xlsx.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>在vue.config.js中的配置如下</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports<span class="token operator">=</span><span class="token punctuation">{</span>
    configureWebpack<span class="token operator">:</span><span class="token punctuation">{</span>
        externals<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">'element-ui'</span><span class="token operator">:</span> <span class="token string">'ELEMENT'</span><span class="token punctuation">,</span>
            <span class="token string">'vue'</span><span class="token operator">:</span> <span class="token string">'Vue'</span><span class="token punctuation">,</span>
            <span class="token string">'vue-router'</span><span class="token operator">:</span> <span class="token string">'VueRouter'</span><span class="token punctuation">,</span>
            <span class="token string">'xlsx'</span><span class="token operator">:</span> <span class="token string">'XLSX'</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>用<code>externals</code>提取第三方依赖之后,代码原先引入依赖的地方是可以不用更改的.</p> <p>比如main.js中</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> ElementUI <span class="token keyword">from</span> <span class="token string">'element-ui'</span><span class="token punctuation">;</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>ElementUI<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>除非<code>&lt;script src=&quot;https://unpkg.com/element-ui@2.10.1/lib/index.js&quot;&gt;&lt;/script&gt;</code>被放置在了app.js之后</p> <p>比如</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>body</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">id</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>app<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/vue/2.6.11/vue.runtime.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/vue-router/3.2.0/vue-router.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://cdn.bootcdn.net/ajax/libs/xlsx/0.16.1/xlsx.min.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>body</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span> <span class="token attr-name">src</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>https://unpkg.com/element-ui@2.10.1/lib/index.js<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token script"></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>那么打包编译之后,会变成</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642420165044-ff2d61d4-3e81-449f-a6b0-679ae838d189.webp" alt="img"></p> <p>此时就会报错了</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642420174815-5279d40d-ae2f-4ca2-930c-fdee14518cbc.webp" alt="img"></p> <p>这个时候就得在main.js中把依赖引入和use的部分去掉</p> <p><strong>原因:</strong></p> <p><strong>前面的element-ui的CDN链接放在了app.js后面引入,但是main.js里面的代码都会编译打包到app.js中,执行app.js时就会遇到需要</strong><code>import</code><strong>对应的element-ui模块,但是此时因为还没引入,所以报错</strong></p> <p>提取完之后再执行一次打包,观察分析图</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642420352385-a09b5bba-40d1-4786-a3b3-c5ca5f4daf7c.webp" alt="img"></p> <p>之前的依赖都已消失,优化成效明显</p> <h4 id="路由懒加载"><a href="#路由懒加载" class="header-anchor">#</a> 路由懒加载</h4> <p>传统路由配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token keyword">import</span> Login <span class="token keyword">from</span> <span class="token string">'@/views/login/index.vue'</span>
<span class="token keyword">import</span> Home <span class="token keyword">from</span> <span class="token string">'@/views/home/home.vue'</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 routes<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/login'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Login <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/home'</span><span class="token punctuation">,</span> component<span class="token operator">:</span> Home <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> router
</code></pre></div><p>路由懒加载写法</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> VueRouter <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
 
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>VueRouter<span class="token punctuation">)</span>
<span class="token keyword">const</span> router <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">VueRouter</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
 routes<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/login'</span><span class="token punctuation">,</span> <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/login/index.vue'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> path<span class="token operator">:</span> <span class="token string">'/home'</span><span class="token punctuation">,</span>  <span class="token function-variable function">component</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">import</span><span class="token punctuation">(</span><span class="token string">'@/views/home/home.vue'</span><span class="token punctuation">)</span> <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
 
<span class="token keyword">export</span> <span class="token keyword">default</span> router
</code></pre></div><h4 id="gzip压缩"><a href="#gzip压缩" class="header-anchor">#</a> Gzip压缩</h4> <p>前提是服务器那边需要开启Gzip</p> <p>通常开启gzip压缩能够有效缩小传输资源的大小,利用<code>compression-webpack-plugin</code>让webpack在打包的时候输出.gz后缀的压缩文件</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">//cnpm install compression-webpack-plugin --save-dev </span>

<span class="token comment">// vue.config.js</span>
<span class="token keyword">const</span> CompressionPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;compression-webpack-plugin&quot;</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">configureWebpack</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token punctuation">{</span>
        plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
          <span class="token keyword">new</span> <span class="token class-name">CompressionPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.js$|.html$|.css$|.jpg$|.jpeg$|.png</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token comment">// 需要压缩的文件类型</span>
            threshold<span class="token operator">:</span> <span class="token number">10240</span><span class="token punctuation">,</span> <span class="token comment">// 归档需要进行压缩的文件大小最小值，我这个是10K以上的进行压缩</span>
            deleteOriginalAssets<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 是否删除原文件</span>
            minRatio<span class="token operator">:</span> <span class="token number">0.8</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">]</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就不需要服务器主动压缩我们就可以得到gzip文件,只要把.gz的文件放在服务器上,就可以让服务器优先返回.gz文件,在面对高流量时也能一定程度减轻服务器的压力,属于是空间换时间</p> <h4 id="图片压缩"><a href="#图片压缩" class="header-anchor">#</a> 图片压缩</h4> <p>使用<code>image-webpack-loader</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>   module<span class="token operator">:</span> <span class="token punctuation">{</span>
      rules<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
          test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.(png|jpe?g|gif|svg)(\?.*)?$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
          use<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
              loader<span class="token operator">:</span> <span class="token string">&quot;image-webpack-loader&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 压缩图片</span>
              options<span class="token operator">:</span> <span class="token punctuation">{</span>
                bypassOnDebug<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
              <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
          <span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><h4 id="prefetch"><a href="#prefetch" class="header-anchor">#</a> Prefetch</h4> <p>实例:</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642422866447-6b421481-b298-41ac-a245-cb832c0c5271.webp" alt="img"></p> <p>列表第一次展开时,优惠券背景有一个逐渐显示的过程,体验上不是很好.</p> <p>原因是因为优惠券列表展开时需要去加载图片,当网速慢时该问题会比较明显.</p> <p><strong>如果能在优惠券列表渲染前就加载好背景图,这个问题就不会出现</strong></p> <p>**prefetch(链接预取)**是一种浏览器机制,其利用浏览器空闲时间来下载或预取用户在不久的将来可能访问的文档.</p> <p>网页向浏览器提供一组预取提示,并在浏览器完成当前页面的加载后开始静默地拉取指定的文档并将其存储在缓存中</p> <p>具体来说,浏览器通过标签来实现预加载</p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>prefetch<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>static/img/ticket_bg.a5bb7c33.png<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>查看现在优惠券列表的加载效果</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642423013864-2e86ba53-e7c1-445c-859f-b3ba746760af.webp" alt="img"></p> <p>达到了期望,观察一下network面板</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642423030618-209f058e-542a-4028-8c3b-6933e3170002.webp" alt="img"></p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642423057403-cb3cf29e-d32d-4fa2-b082-0920725da3be.webp" alt="img"></p> <p>在首屏的请求中,请求列表已经出现了优惠券背景图ticket_bg.png的加载请求;</p> <p>展开优惠券列表之后,network中增加了一个新的ticket_bg.png的访问请求,但有一个特殊标记 <code>prefetch cache</code>,表明这次请求用的是prefetch请求.</p> <p><strong>即浏览器在空闲时间预先加载资源,真正使用时直接从浏览器缓存中快速获取</strong></p> <h4 id="preload"><a href="#preload" class="header-anchor">#</a> Preload</h4> <p><strong>preload为预加载</strong></p> <p>元素的rel属性的属性值<code>preload</code>能够让你的html页面指明哪些资源是在页面加载完成后立即需要的.</p> <p>这些即刻需要的资源,我们希望在页面加载的生命周期的早期阶段就开始获取,在浏览器的主渲染机制介入前就进行预加载.</p> <p>简单来说,就是通过标签显示声明一个高优先级资源,强制浏览器提前请求,同时不阻塞文档正常onload.</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642423430784-69f6a8bd-0adb-4e8d-abe2-7243d868d4d6.webp" alt="img"></p> <p>上面的页面使用了自定义字体.</p> <p>但是页面首次加载时文字会出现短暂的字体样式闪动,在网络较差时情况比较明显.</p> <p><strong>原因是 字体文件由css引入,在css解析之后才会加载,加载完成之前浏览器只能使用降级字体.</strong></p> <p><strong>也就是说字体加载的时机太迟,需要浏览器提前告知进行加载</strong></p> <div class="language-html extra-class"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>head</span><span class="token punctuation">&gt;</span></span>
    ...
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>font<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>&lt;%= require(<span class="token punctuation">'</span>/assets/fonts/AvenirNextLTPro-Demi.otf<span class="token punctuation">'</span>) %&gt;<span class="token punctuation">&quot;</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>link</span> <span class="token attr-name">rel</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>preload<span class="token punctuation">&quot;</span></span> <span class="token attr-name">as</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>font<span class="token punctuation">&quot;</span></span> <span class="token attr-name">href</span><span class="token attr-value"><span class="token punctuation attr-equals">=</span><span class="token punctuation">&quot;</span>&lt;%= require(<span class="token punctuation">'</span>/assets/fonts/AvenirNextLTPro-Regular.otf<span class="token punctuation">'</span>) %&gt;<span class="token punctuation">&quot;</span></span> <span class="token attr-name">crossorigin</span><span class="token punctuation">&gt;</span></span>
    ...
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>head</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642424266514-edd9dcd1-3ad9-4355-b643-5f5c07962548.webp" alt="img"></p> <p>对比一下network面板</p> <p>前:</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642424284619-a3ba2c76-0c44-4a8b-bff4-0f851713016e.webp" alt="img"></p> <p>后:</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642424298756-0b7d13a8-0d0c-4441-adcf-c7cb23030169.webp" alt="img"></p> <p>可以发现字体文件的加载时机明显提前了</p> <p>preload link必须设置as属性来声明资源类型(font/image/style/script)</p> <p><strong>vue-cli3中默认配置</strong></p> <ul><li><strong>preload</strong></li></ul> <p>默认情况下,vue-cli会为所有初始化渲染需要的文件自动生成preload提示</p> <ul><li><strong>prefetch</strong></li></ul> <p>默认情况下,vue-cli会为所有作为async chunk生成的JavaScript自动生成prefetch提示</p> <h2 id="module-chunk-bundle区别"><a href="#module-chunk-bundle区别" class="header-anchor">#</a> module,chunk,bundle区别</h2> <p>目录结构</p> <div class="language-plain extra-class"><pre class="language-plain"><code>src/
├── index.css
├── index.html # 这个是 HTML 模板代码
├── index.js
├── common.js
└── utils.js
</code></pre></div><p>webpack配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token punctuation">{</span>
    entry<span class="token operator">:</span> <span class="token punctuation">{</span>
        index<span class="token operator">:</span> <span class="token string">&quot;../src/index.js&quot;</span><span class="token punctuation">,</span>
        utils<span class="token operator">:</span> <span class="token string">'../src/utils.js'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    output<span class="token operator">:</span> <span class="token punctuation">{</span>
        filename<span class="token operator">:</span> <span class="token string">&quot;[name].bundle.js&quot;</span><span class="token punctuation">,</span> <span class="token comment">// 输出 index.js 和 utils.js</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                use<span class="token operator">:</span> <span class="token punctuation">[</span>
                    MiniCssExtractPlugin<span class="token punctuation">.</span>loader<span class="token punctuation">,</span> <span class="token comment">// 创建一个 link 标签</span>
                    <span class="token string">'css-loader'</span><span class="token punctuation">,</span> <span class="token comment">// css-loader 负责解析 CSS 代码, 处理 CSS 中的依赖</span>
                <span class="token punctuation">]</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">,</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
    plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token comment">// 用 MiniCssExtractPlugin 抽离出 css 文件，以 link 标签的形式引入样式文件</span>
        <span class="token keyword">new</span> <span class="token class-name">MiniCssExtractPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
            filename<span class="token operator">:</span> <span class="token string">'index.bundle.css'</span> <span class="token comment">// 输出的 css 文件名为 index.css</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>运行打包,结果如下</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642426398429-3d5c6dcb-70f9-4810-a0b8-d3b94cddf25f.webp" alt="img"></p> <p><code>index.css</code>和<code>common.js</code>在index.js中被引入,打包生成的index.bundle.css和index.bundle.js都属于chunk0,因为utils独立打包,它生成的utils.bundle.js属于chunk1</p> <p>示例图</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642426568657-997ea1ed-628f-48c8-8a05-936defd9f4b1.webp" alt="img"></p> <ul><li><p>对于一份代码,当我们手写下一个一个的文件,无论它们是ESM还是commonJS或AMD,它们都是module</p></li> <li><p>当我们写的module源文件传到webpack打包时,webpack会根据文件引用关系生成chunk文件</p></li> <li><p>webpack处理好chunk文件之后,最后会输出bundle文件,这个bundle文件包含了经过加载和编译的最终结果源源文件,所以它可以直接在浏览器运行</p></li></ul> <p>一般来说一个chunk对应一个bundle</p> <p>比如:<code>utils.js =&gt; chunks 1 =&gt; utils.bundle.js</code></p> <p>但也有例外,比如用<code>MiniCssExtractPlugin</code>从<code>chunks 0</code>中抽离了<code>index.bundle.css</code>文件</p> <h3 id="总结-2"><a href="#总结-2" class="header-anchor">#</a> 总结</h3> <p><code>module``chunk``bundle</code>其实就是同一份逻辑代码在不同转换场景下取的三个名字.</p> <p>我们直接写出来的是module,webpack处理时是chunk,最后生成浏览器可以直接运行的是bundle.</p> <h2 id="loader-2"><a href="#loader-2" class="header-anchor">#</a> loader</h2> <h3 id="概念-2"><a href="#概念-2" class="header-anchor">#</a> 概念</h3> <p>Loader本质上就是一个函数,loader用于对模块的源代码进行转换.</p> <p>loader可以使你在<code>import</code>模块时预处理文件.</p> <p>loader可以将文件从不同的语言如ts转换成JavaScript或将内联图像转换为data URL</p> <p><code>webpack</code>中通过compliation对象进行模块编译时,会首先进行匹配<code>loader</code>处理文件得到结果(<code>string/buffer</code>),之后才会输出给<code>webpack</code>进行编译</p> <p><strong>简单来说,loader就是一个函数,通过它我们可以在webpack处理我们的特定资源之前进行提前处理</strong></p> <p><strong>比如说,webpack只能识别js模块,而我们在使用</strong><code>typescript</code>编写代码时可以提前通过<code>babel-loader</code>将<code>.ts</code>后缀文件提前编译成<code>JavaScript</code>代码,之后交给webpack处理</p> <h3 id="基础配置参数"><a href="#基础配置参数" class="header-anchor">#</a> 基础配置参数</h3> <p>示例配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> use<span class="token operator">:</span> <span class="token string">'css-loader'</span><span class="token punctuation">,</span>enforce<span class="token operator">:</span> <span class="token string">'post'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.ts$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> use<span class="token operator">:</span> <span class="token string">'ts-loader'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>我们通过<code>module</code>中的<code>rules</code>属性来配置<code>loader</code></p> <h4 id="test"><a href="#test" class="header-anchor">#</a> test</h4> <p><code>test</code>是一个正则表达式,根据test的规则去匹配文件,匹配到的就会交给对应的loader处理</p> <h4 id="use"><a href="#use" class="header-anchor">#</a> use</h4> <p><code>use</code>表示匹配到test中的文件时,应该用哪个loader的规则去处理.</p> <p><code>use</code>可以是一个字符串,也可以是一个数组</p> <p>如果use为一个数组时表示有多个loader依次处理匹配的资源,按照<strong>从右往左的顺序处理</strong></p> <h4 id="enforce"><a href="#enforce" class="header-anchor">#</a> enforce</h4> <p>loader中存在一个<code>enforce</code>参数标志loader的顺序</p> <p>示例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> use<span class="token operator">:</span> <span class="token string">'sass-loader'</span><span class="token punctuation">,</span> enforce<span class="token operator">:</span> <span class="token string">'pre'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> use<span class="token operator">:</span> <span class="token string">'css-loader'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.css$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> use<span class="token operator">:</span> <span class="token string">'style-loader'</span><span class="token punctuation">,</span> enforce<span class="token operator">:</span> <span class="token string">'post'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>针对<code>.css</code>结尾的资源文件,我们在打包过程中<code>module.rules</code>分别有三条规则匹配到,也就是对于同一个<code>.css</code>文件我们需要使用匹配到的三个loader分别进行处理.</p> <p>而<strong>enforce</strong>可以决定处理的顺序</p> <ul><li><p>默认值为<code>normal loader</code></p></li> <li><p>配置<code>enforce:'pre'</code>参数时,我们称之为<code>pre loader</code>(前置loader)</p></li> <li><p>配置<code>enforc:'post'</code>参数时,我们称之为<code>post loader</code>(后置loader)</p></li></ul> <p>三种loader的执行顺序</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642508257746-d9ba0153-3ede-4680-91f8-36d0f55cf151.webp" alt="img"></p> <h3 id="loader的路径"><a href="#loader的路径" class="header-anchor">#</a> loader的路径</h3> <p>通常配置时都是直接使用loader的名称,如</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的配置相当于告诉<code>webpack</code>关于<code>js</code>结尾的文件使用<code>babel-loader</code>去处理,那么问题是它是如何寻找到<code>babel-loader</code>的真实内容的</p> <h4 id="绝对路径"><a href="#绝对路径" class="header-anchor">#</a> 绝对路径</h4> <p>第一种方式在项目内部存在一些未发布的自定义<code>loader</code>时比较常见,<strong>直接使用绝对路径地址的形式指向</strong><code>loader</code><strong>文件所在的地址</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                loader<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'../loaders/babel-loader.js'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="resolveloader-alias"><a href="#resolveloader-alias" class="header-anchor">#</a> resolveLoader.alias</h4> <p>第二种方式使用<code>webpack</code>中的<code>resolveLoader</code>的别名<code>alias</code>方式进行配置</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    resolveLoader<span class="token operator">:</span> <span class="token punctuation">{</span>
        alias<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">'babel-loader'</span><span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'../loaders/babel-loader.js'</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时,当webpack在解析到loader中使用babel-loader时,查找到alias中定义了babel-loader的文件路径,就会按这个路径去寻找</p> <p>但是每次一个loader都要配一个别名太麻烦了</p> <h4 id="resolveloader-modules"><a href="#resolveloader-modules" class="header-anchor">#</a> resolveLoader.modules</h4> <p>我们可以通过<code>resolveLoader.modules</code>定义webpack在解析loader时应该查找的目录</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
<span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token operator">...</span>
    resolveLoader<span class="token operator">:</span> <span class="token punctuation">{</span>
        modules<span class="token operator">:</span> <span class="token punctuation">[</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span><span class="token string">'../loaders/'</span><span class="token punctuation">)</span> <span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    module<span class="token operator">:</span> <span class="token punctuation">{</span>
        rules<span class="token operator">:</span> <span class="token punctuation">[</span>
            <span class="token punctuation">{</span>
                test<span class="token operator">:</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
                loader<span class="token operator">:</span> <span class="token string">'babel-loader'</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>resolveLoader.modules的默认值是<code>['node_modules']</code>,也就是我们的第三方依赖</p> <h3 id="loader种类"><a href="#loader种类" class="header-anchor">#</a> Loader种类</h3> <p>enforce参数将loader分成了三类</p> <ul><li><p>pre loader</p></li> <li><p>normal loader</p></li> <li><p>post loader</p></li></ul> <p>同时<code>webpack</code>还支持一种内联的方式配置<code>loader</code>,比如</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">import</span> Styles <span class="token keyword">from</span> <span class="token string">'style-loader!css-loader!./styles.css'</span><span class="token punctuation">;</span>
</code></pre></div><p>上述在引用style.css时,调用了<code>css-loader</code>和<code>style-loader</code>进行提前处理文件</p> <p>所以综上,<code>loader</code>的四种类型分别是</p> <ul><li><p>pre loader</p></li> <li><p>normal loader</p></li> <li><p>inline loader</p></li> <li><p>post loader</p></li></ul> <h3 id="loader的执行顺序"><a href="#loader的执行顺序" class="header-anchor">#</a> Loader的执行顺序</h3> <h4 id="默认顺序"><a href="#默认顺序" class="header-anchor">#</a> 默认顺序</h4> <p>在<strong>默认的</strong><code>loader</code>执行阶段,四种loader会按照下面的顺序执行</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642509530512-d11337c6-0fcc-48e3-9c70-2e75baa7e177.webp" alt="img"></p> <p>在<code>webpack</code>进行编译文件之前,资源文件匹配对应的<code>loader</code>:</p> <ul><li><p>执行pre loader前置处理文件</p></li> <li><p>将pre loader执行后的资源链式传递给normal loader正常的loader处理</p></li> <li><p>normal loader处理结束后交给inline loader处理</p></li> <li><p>最终通过post loader处理文件,将处理的结果交给webpack进行模块编译</p></li></ul> <p>以上的loader的<strong>默认</strong>处理顺序</p> <h4 id="loader的pitch阶段"><a href="#loader的pitch阶段" class="header-anchor">#</a> loader的pitch阶段</h4> <p>关于<code>loader</code>的执行阶段其实分为两种阶段:</p> <ul><li><p>在处理资源文件之前,首先会经历<code>pitch</code>阶段</p></li> <li><p><code>pitch</code>结束后,读取资源文件内容</p></li> <li><p>经过<code>pitch</code>处理后,读取到了资源文件,此时才会将读取到的资源文件内容交给正常阶段的<code>loader</code>进行处理</p></li></ul> <p>简单来说就是所谓的loader在处理文件资源时分为两个阶段:pitch阶段和normal阶段</p> <p>示例:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token comment">// 普通loader</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'normal1-loader'</span><span class="token punctuation">,</span> <span class="token string">'normal2-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 前置loader</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'pre1-loader'</span><span class="token punctuation">,</span> <span class="token string">'pre2-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        enforce<span class="token operator">:</span> <span class="token string">'pre'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token comment">// 后置loader</span>
      <span class="token punctuation">{</span>
        test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\.js$</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
        use<span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'post1-loader'</span><span class="token punctuation">,</span> <span class="token string">'post2-loader'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        enforce<span class="token operator">:</span> <span class="token string">'post'</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token comment">// 入口文件中</span>
<span class="token keyword">import</span> something <span class="token keyword">from</span> <span class="token string">'inline1-loader!inline2-loader!./title.js'</span><span class="token punctuation">;</span>
</code></pre></div><p>配置中的loader的执行顺序如下图</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642510074607-79679e54-3798-4ae3-8595-d956315bb93f.webp" alt="img"></p> <p>webpack在使用loader处理资源时首先会经过<code>loader.pitch</code>阶段,<code>pitch</code>阶段结束后才会读取文件而后进行正常阶段处理</p> <ul><li>**Pitch阶段:**loader上的pitch方法,按照<code>post,inline,normal,pre</code>的顺序调用</li> <li>**Normal阶段:**loader上的常规方法,按照<code>pre,normal,inline,post</code>执行.<strong>模块源码的转换,发生在这个阶段</strong></li></ul> <h3 id="pitch-loader"><a href="#pitch-loader" class="header-anchor">#</a> pitch-loader</h3> <h4 id="熔断机制"><a href="#熔断机制" class="header-anchor">#</a> 熔断机制</h4> <p>上述提到<code>webpack</code>编译资源时首先经过<code>loader</code>的处理,会经过两个阶段分别是<code>pitch</code>和<code>normal</code>阶段</p> <p>而在<code>pitch</code>阶段有一个重要的特性:</p> <p><strong>pitch loader中如果存在非</strong><code>undefined</code><strong>的返回值的话,那么上述图中的整个</strong><code>loader chain</code><strong>会发生熔断效果.</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642510719785-1fed8692-7ebd-487a-84c1-ce1dd02a65c5.webp" alt="img"></p> <p>假设在<code>inline-loader</code>的<code>pitch</code>阶段返回了一个字符串,那么此时<code>loader</code>的执行会打破原有的顺序</p> <p><strong>它会立马掉头,去执行该阶段之前的loader,如上图所示</strong></p> <ul><li><strong>pitch阶段返回的非</strong><code>undefined</code><strong>的值会造成loader打破原有的顺序掉头执行,这就是熔断效果</strong></li> <li><strong>正常执行时是会读取资源文件内容交给normal loader去处理,但是pitch存在返回值发生熔断并不会读取文件内容了.此时pitch函数的返回值会交给将要执行的normal loader</strong></li></ul> <h4 id="作用-2"><a href="#作用-2" class="header-anchor">#</a> 作用</h4> <p>示例:</p> <p><code>style-loader</code>是常用的一个loader</p> <p>它要做的事情很简单: 获得对应的样式文件内容,然后通过在页面创建<code>style</code>标签.将样式内容赋给<code>style</code>节点然后将节点加入<code>head</code>标签即可</p> <p>简单的逻辑代码:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">styleLoader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
    const styleEl = document.createElement('style')
    styleEl.innerHTML = </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>source<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">
    document.head.appendChild(styleEl)
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> script<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>style-loader</code>一般需要和<code>css-loader</code>进行配合.</p> <p>而如果按上面<code>style-loader</code>的逻辑,<code>css-loader</code>的<code>normal</code>阶段会将样式文件处理成为<code>js</code>脚本并且返回给<code>style-loader</code>的函数中,也就是<code>source</code></p> <p>source的内容是一个js脚本,我们将js脚本的内容插入到styleEl中去,样式当然是不会生效的.</p> <p><strong>这也就意味着,如果style-loader设计成normal-loader的话,我们需要执行上一个loader返回的js脚本,并且获取它导出的内容才可以得到对应的样式内容.</strong></p> <p><strong>那么我们此时需要在style-loader的normal阶段实现一系列js方法才可以达到目的</strong></p> <p><strong>更好的处理方法:将style-loader设计成</strong><code>pitch-loader</code></p> <p>如果在<code>style-loader</code>的<code>pitch</code>阶段直接返回值的话,就会发生熔断效应</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642512661971-aa20bb11-4c08-41b9-8f5b-b43e0ced81f1.webp" alt="img"></p> <p>我们可以在<code>style-loader</code>的<code>pitch</code>阶段通过<strong>require语句 引入css-loader处理文件返回后的js脚本,得到导出的结果,整个阶段是由webpack帮我们完成的.</strong></p> <p>意思就是 style-loader的pitch方法里面调用了<strong>require('!!.../x.css')</strong>，这就会把require的css文件当作<strong>新的入口文件</strong>，重新链式调用剩余的loader函数进行处理。<strong>（值得注意的是'!!'是一个标志，表示不会再重复递归调用style-loader，而只会调用css-loader处理了）</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">styleLoader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token comment">// pitch阶段</span>
styleLoader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">remainingRequest<span class="token punctuation">,</span> previousRequest<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//pitch阶段的remainingRequest表示剩余还未处理loader的绝对路径以&quot;!&quot;拼接(包含资源路径)的字符串</span>
  <span class="token keyword">const</span> script <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">
  import style from &quot;!!</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>remainingRequest<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot;

    const styleEl = document.createElement('style')
    styleEl.innerHTML = style
    document.head.appendChild(styleEl)
  </span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> script<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> styleLoader
</code></pre></div><h4 id="总结-3"><a href="#总结-3" class="header-anchor">#</a> 总结</h4> <p>如果loader的开发中,需要依赖其他loader的处理结果,但是上一个loader的函数返回的并不是处理后的资源文件而是一段<code>js</code>脚本,那么将loader的逻辑设计在pitch阶段是一种更好的方式.</p> <h3 id="normal-loader-pitch-loader参数"><a href="#normal-loader-pitch-loader参数" class="header-anchor">#</a> normal loader &amp; pitch loader参数</h3> <h4 id="normal-loader"><a href="#normal-loader" class="header-anchor">#</a> normal loader</h4> <p><code>normal loader</code>默认接受一个参数,这个参数是需要处理的文件内容,若存在多个<code>loader</code>时,它的参数会受上一个<code>loader</code>的影响</p> <p>同时<code>normal loader</code>存在一个返回值,这个返回值会链式调用给下一个<code>loader</code>作为入参,当最后一个<code>loader</code>处理完成之后,会将这个返回值返回给<code>webpack</code>进行编译.</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// source为需要处理的源文件内容 </span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token comment">// 同时返回本次处理后的内容</span>
    <span class="token keyword">return</span> source <span class="token operator">+</span> <span class="token string">'hello !'</span>
<span class="token punctuation">}</span>
</code></pre></div><p>normal loader中会有很多属性挂载在函数的<code>this</code>上,比如我们通常使用loader时会在外部传递一些参数,此时这些参数就可以通过函数内部的 <code>this.getOptions()</code>方法获取.</p> <p><strong>所以loader不能是一个箭头函数!!</strong></p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642579145899-86acf40b-9883-4131-baca-7dfe863cd926.webp" alt="img"></p> <h4 id="pitch-loader-2"><a href="#pitch-loader-2" class="header-anchor">#</a> pitch loader</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// normal loader</span>
<span class="token keyword">function</span> <span class="token function">loader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
    <span class="token keyword">return</span> source
<span class="token punctuation">}</span>

<span class="token comment">// pitch loader</span>
loader<span class="token punctuation">.</span><span class="token function-variable function">pitch</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">remainingRequest<span class="token punctuation">,</span>previousRequest<span class="token punctuation">,</span>data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>Loader的pitch阶段也是一个函数,它接受三个参数,分别是</p> <ul><li><p>remainingRequest</p></li> <li><p>previousRequest</p></li> <li><p>data</p></li></ul> <p><strong>remainingRequest</strong></p> <p>表示<strong>剩余需要处理的</strong><code>loader</code>,这些<code>loader</code>会以它们的绝对路径加上<code>!</code>进行分割,组织成一个字符串</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642579277440-e1f6af06-9c70-4b7a-807a-38132995ead7.webp" alt="img"></p> <p>在<code>loader2</code>的<code>pitch</code>函数中,它的<code>remainingRequest</code>的值就是<code>xxx/loader3.js</code>的字符串.如果后续还有其他loader,则以<code>!</code>进行分割</p> <p><strong>previousRequest</strong></p> <p>表示<code>**pitch**</code><strong>阶段已经迭代过的</strong><code>**loader**</code><strong>,表示方法和remainingRequest形式一样</strong></p> <p><strong>data</strong></p> <p>该参数默认是一个空对象<code>{}</code></p> <ul><li>当我们在loader2.pitch函数中给data赋值时,比如<code>data.name=&quot;front&quot;</code></li> <li>此时在loader2函数中可以通过<code>this.data.name</code>获取到自身<code>pitch</code>方法中传递的<code>front</code></li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642579524639-43258615-ded3-48c1-b1f3-c6e005e8a102.webp" alt="img"></p> <h4 id="raw"><a href="#raw" class="header-anchor">#</a> raw</h4> <p><code>loader</code>中还有一个<code>raw</code>属性</p> <p>在默认情况下,<code>normal loader</code>的参数是一个字符串.但是当我们要处理图片资源时,将图片变成字符串明显是不合理的.所以针对图片的操作<strong>通常我们需要的是读取图片资源的</strong><code>Buffer</code><strong>类型而非字符串类型.</strong></p> <p>通过<code>loader.raw</code>可以标记传递的参数是<code>Buffer</code>还是<code>String</code></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">function</span> <span class="token function">loader2</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 此时source是一个Buffer类型 而非模型的string类型</span>
<span class="token punctuation">}</span>

loader2<span class="token punctuation">.</span>raw <span class="token operator">=</span> <span class="token boolean">true</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> loader2
</code></pre></div><h2 id="自定义loader"><a href="#自定义loader" class="header-anchor">#</a> 自定义loader</h2> <h3 id="去除打印信息"><a href="#去除打印信息" class="header-anchor">#</a> 去除打印信息</h3> <h4 id="loader内容"><a href="#loader内容" class="header-anchor">#</a> loader内容</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// source：表示当前要处理的内容</span>
<span class="token keyword">const</span> reg <span class="token operator">=</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">(console.log()(.*)())</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">;</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 通过正则表达式将当前处理内容中的console替换为空字符串</span>
    source <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>reg<span class="token punctuation">,</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">)</span>
    <span class="token comment">// 再把处理好的内容return出去，坚守输入输出都是字符串的原则，并可达到链式调用的目的供下一个loader处理</span>
    <span class="token keyword">return</span> source
<span class="token punctuation">}</span>
</code></pre></div><h4 id="webpack配置中引入"><a href="#webpack配置中引入" class="header-anchor">#</a> webpack配置中引入</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code>module<span class="token operator">:</span> <span class="token punctuation">{</span>
    rules<span class="token operator">:</span><span class="token punctuation">[</span>
        <span class="token punctuation">{</span>
            test<span class="token operator">:</span> <span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">.js</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span>
            use<span class="token operator">:</span> <span class="token punctuation">[</span>
               <span class="token punctuation">{</span>
                loader<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">&quot;./dropConsole.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
               <span class="token punctuation">}</span>
            <span class="token punctuation">]</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
   <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>正常运行之后 调试台不会打印console的信息</p> <h3 id="babel-loader"><a href="#babel-loader" class="header-anchor">#</a> babel-loader</h3> <p><code>babel-loader</code>实现的功能比较简单,本质上是通过<code>babel-loader</code>将js文件进行转化</p> <h4 id="loader内容-2"><a href="#loader内容-2" class="header-anchor">#</a> loader内容</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> core <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/**
 *
 * @param {*} source 源代码内容
 */</span>
<span class="token keyword">function</span> <span class="token function">babelLoader</span><span class="token punctuation">(</span><span class="token parameter">source</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 获取loader参数</span>
  <span class="token keyword">const</span> options <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token comment">// 通过transform方法进行转化</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> code<span class="token punctuation">,</span> map<span class="token punctuation">,</span> ast <span class="token punctuation">}</span> <span class="token operator">=</span> core<span class="token punctuation">.</span><span class="token function">transform</span><span class="token punctuation">(</span>source<span class="token punctuation">,</span> options<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 调用this.callback表示loader执行完毕</span>
  <span class="token comment">// 同时传递多个参数给下一个loader</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> code<span class="token punctuation">,</span> map<span class="token punctuation">,</span> ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> babelLoader<span class="token punctuation">;</span>
</code></pre></div><ul><li>通过<code>core.transform</code>将源js代码进行<code>ast</code>转化 同时传递外部参数处理<code>ast</code>节点的转化,从而可以按照外部传入的规则将js代码转化为想要的目标代码</li> <li>通过this.getOptions获得外部传递的参数</li></ul> <h2 id="tapable"><a href="#tapable" class="header-anchor">#</a> Tapable</h2> <p>在<code>webpack</code>的编译过程,本质上通过Tapable实现了在编译过程中的一种<strong>发布订阅模式</strong>的plugin机制</p> <p>通过Tapable我们可以注册事件,从而在不同时机去触发注册的事件进行执行.</p> <p>Webpack中的plugin机制正是基于这种机制实现在不同编译阶段调用不同插件从而影响编译的结果.</p> <p>Tapable官方提供了九种钩子</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>
	SyncHook<span class="token punctuation">,</span>
	SyncBailHook<span class="token punctuation">,</span>
	SyncWaterfallHook<span class="token punctuation">,</span>
	SyncLoopHook<span class="token punctuation">,</span>
	AsyncParallelHook<span class="token punctuation">,</span>
	AsyncParallelBailHook<span class="token punctuation">,</span>
	AsyncSeriesHook<span class="token punctuation">,</span>
	AsyncSeriesBailHook<span class="token punctuation">,</span>
	AsyncSeriesWaterfallHook
 <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;tapable&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以<code>SyncHook</code>为例</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// 初始化同步钩子</span>
<span class="token keyword">const</span> hook <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SyncHook</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&quot;arg1&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;arg2&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;arg3&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 注册事件</span>
hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'flag1'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span>arg2<span class="token punctuation">,</span>arg3</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'flag1:'</span><span class="token punctuation">,</span>arg1<span class="token punctuation">,</span>arg2<span class="token punctuation">,</span>arg3<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

hook<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'flag2'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">arg1<span class="token punctuation">,</span>arg2<span class="token punctuation">,</span>arg3</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'flag2:'</span><span class="token punctuation">,</span>arg1<span class="token punctuation">,</span>arg2<span class="token punctuation">,</span>arg3<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token comment">// 调用事件并传递执行参数</span>
<span class="token function">hook</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token string">'19Qingfeng'</span><span class="token punctuation">,</span><span class="token string">'wang'</span><span class="token punctuation">,</span><span class="token string">'haoyu'</span><span class="token punctuation">)</span>

<span class="token comment">// 打印结果</span>
flag1<span class="token operator">:</span> <span class="token number">19</span>Qingfeng wang haoyu
flag2<span class="token operator">:</span> <span class="token number">19</span>Qingfeng wang haoyu
</code></pre></div><ul><li><p>通过new关键字实例不同种类的Hook</p></li> <li><p>通过tap监听对应的事件</p></li> <li><ul><li>第一个参数是一个标识位,类似于id的作用</li> <li>第二个参数是本次注册的函数,在调用时执行</li></ul></li> <li><p>call方法传入对应的参数,调用注册在hook内部的事件函数进行执行</p></li></ul> <p>更多内容:https://juejin.cn/post/7040982789650382855#heading-47</p> <h2 id="plugin-2"><a href="#plugin-2" class="header-anchor">#</a> Plugin</h2> <p>本质上在Webpack编译阶段会为各个编译对象初始化不同的Hook,开发者可以在自己编写的Plugin中监听到这些Hook,在打包的某个特定时间段触发对应Hook注入特定的逻辑从而实现自己的行为.</p> <h3 id="常用的对象"><a href="#常用的对象" class="header-anchor">#</a> 常用的对象</h3> <p>以下对象可以注册Hook:</p> <ul><li><p>compiler Hook</p></li> <li><p>compilation Hook</p></li> <li><p>ContextModuleFactory Hook</p></li> <li><p>JavascriptParser Hook</p></li> <li><p>NormalModuleFactory Hook</p></li></ul> <h3 id="基本构成"><a href="#基本构成" class="header-anchor">#</a> 基本构成</h3> <p>示例一个简单的插件,它会在编译完成时执行输出done:</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">DonePlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 Compiler Hook 注册额外逻辑</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">'Plugin Done'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'compilation done'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> DonePlugin<span class="token punctuation">;</span>
</code></pre></div><p>可以看到一个Webpack Plugin主要由以下几方面组成:</p> <ul><li><p>首先一个Plugin应该是一个class,当然也可以是一个函数</p></li> <li><p>Plugin的原型对象上存在一个apply方法,当webpack创建compiler对象时会调用各个插件实例上的apply方法,并传入compiler对象作为参数</p></li> <li><p>同时指定一个绑定在compiler对象上的Hook,比如<code>compiler.hooks.done.tap</code>,在传入的compiler对象上监听done事件</p></li> <li><p>在Hook的回调中处理插件自身的逻辑</p></li> <li><p>根据Hook的种类,在完成逻辑后通知webpack继续进行</p></li></ul> <h3 id="插件的构建对象"><a href="#插件的构建对象" class="header-anchor">#</a> 插件的构建对象</h3> <h4 id="compiler"><a href="#compiler" class="header-anchor">#</a> compiler</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">DonePlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 Compiler Hook 注册额外逻辑</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span><span class="token string">'Plugin Done'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>compiler<span class="token punctuation">,</span> <span class="token string">'compiler 对象'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> DonePlugin<span class="token punctuation">;</span>
</code></pre></div><p>在compiler对象中保存着完整的Webpack环境配置</p> <p><strong>这个对象会在首次启动Webpack的时候创建,通过</strong><code>compiler</code><strong>对象能够访问到Webpack的主环境配置,比如loader和plugin等配置信息.</strong></p> <p><strong>可以把compiler理解为一个单例,每次启动webpack构建时都是一个独一无二,仅创建一次的对象</strong></p> <p>compiler对象存在以下属性</p> <ul><li><strong>compiler.options</strong></li></ul> <p>该属性存储着本次启动webpack时的所有配置文件,包括但不限于loader entry等信息</p> <ul><li><strong>compiler.hooks</strong></li></ul> <p>扩展了来自tapable的不同种类的Hook,监听这些hook从而可以在compiler生命周期中植入不同逻辑</p> <h4 id="compilation"><a href="#compilation" class="header-anchor">#</a> compilation</h4> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">class</span> <span class="token class-name">DonePlugin</span> <span class="token punctuation">{</span>
  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>afterEmit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>
      <span class="token string">'Plugin Done'</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>compilation<span class="token punctuation">,</span> <span class="token string">'compilation 对象'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> DonePlugin<span class="token punctuation">;</span>
</code></pre></div><p><code>compilation</code>对象代表一次资源的构建,实例可以访问所有的模块和它们的依赖</p> <p><strong>在compilation对象中我们可以获取/操作 本次编译的当前模块资源 编译生成的资源 变化的文件以及被跟踪的状态信息.</strong></p> <p><strong>在devServer下每次修改代码都会进行重新编译,此时可以理解为每次构建都会创建一个新的compilation</strong></p> <p>compilation对象存在的属性</p> <ul><li><p>modules</p></li> <li><p>chunks</p></li> <li><ul><li>chunk是多个modules组成而来的一个代码块,当Webpack进行打包时首先会根据项目入口文件分析对应的依赖关系,将入口依赖的多个modules组合成一个大的对象,这个对象就是chunk.</li> <li>多个chunk组成chunks</li></ul></li> <li><p>assets</p></li> <li><ul><li>assets对象上记录了本次打包生成的所有文件的结果</li></ul></li> <li><p>hooks</p></li></ul> <h3 id="总结-4"><a href="#总结-4" class="header-anchor">#</a> 总结</h3> <p><strong>webpack plugin的核心机制就是基于tapable的发布订阅模式,在不同的周期触发不同的hook从而影响最终的打包结果.</strong></p> <h2 id="自定义plugin"><a href="#自定义plugin" class="header-anchor">#</a> 自定义plugin</h2> <h3 id="需求分析"><a href="#需求分析" class="header-anchor">#</a> 需求分析</h3> <p>前端每次需要把打包好的dist文件发送给后端部署,这时需要开发者每次build之后再次进行压缩,变成压缩包再发给后端.</p> <p><strong>此时,如果可以在build的时候把所有的资源打包成一个zip包,就很方便</strong></p> <h3 id="webpack配置"><a href="#webpack配置" class="header-anchor">#</a> webpack配置</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> CompressAssetsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./plugins/CompressAssetsPlugin'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  mode<span class="token operator">:</span> <span class="token string">'development'</span><span class="token punctuation">,</span>
  entry<span class="token operator">:</span> <span class="token punctuation">{</span>
    main<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./src/entry1.js'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  devtool<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  output<span class="token operator">:</span> <span class="token punctuation">{</span>
    path<span class="token operator">:</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./build'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    filename<span class="token operator">:</span> <span class="token string">'[name].js'</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  plugins<span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token keyword">new</span> <span class="token class-name">CompressAssetsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      output<span class="token operator">:</span> <span class="token string">'result.zip'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>这里自定义的CompressAssetsPlugin,它只接收一个output参数,表示生成的压缩包的名字</p> <h3 id="原理分析"><a href="#原理分析" class="header-anchor">#</a> 原理分析</h3> <p>围绕Webpack打包过程的两个核心对象:</p> <ul><li><p>compiler</p></li> <li><ul><li>compiler在Webpack启动打包时创建,保存着本次打包的所有初始化配置信息</li> <li><strong>在每一次进行打包过程中它会创建</strong><code>compilation</code><strong>对象进行模块打包.</strong></li></ul></li> <li><p>compilation</p></li> <li><ul><li>compilation代表这一次资源构建的过程,在compliation对象我们可以通过一系列API访问/修改本次打包生成的module assets chunks</li></ul></li></ul> <h4 id="需要用到的库和hook"><a href="#需要用到的库和hook" class="header-anchor">#</a> 需要用到的库和hook</h4> <ul><li><p>JSZIP</p></li> <li><ul><li>这是一个JS生成zip压缩包的库</li></ul></li> <li><p>compiler Emit Hook</p></li> <li><ul><li>compiler对象上的Emit Hook会在输出asset到output目录之前执行,简单来说就是每次即将打包完成生成文件时调用这个钩子</li></ul></li> <li><p>compilation对象方法</p></li> <li><ul><li>在打包过程中需要获取本次打包即将生成的资源,可以使用<code>compilation.getAssets()</code>方法获取原始打包的资源源文件内容,之后通过<code>compilation.emitAssets()</code>输出生成的zip到打包结果去</li></ul></li></ul> <h3 id="基础内容"><a href="#基础内容" class="header-anchor">#</a> 基础内容</h3> <p><strong>任何一个Webpack Plugin都是一个模块,这个模块导出了一个类或者说是函数,该函数必须存在一个名为apply的原型方法.</strong></p> <p><strong>在调用webpack()方法开始打包时,会将compiler对象传递给每一个插件的apply方法并且调用他们注册的Hook</strong></p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> pluginName <span class="token operator">=</span> <span class="token string">'CompressAssetsPlugin'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CompressAssetsPlugin</span> <span class="token punctuation">{</span>
  <span class="token comment">// 在配置文件中传入的参数会保存在插件实例中</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> output <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 接受外部传入的 output 参数</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>output <span class="token operator">=</span> output<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 注册函数 在webpack即将输出打包文件内容时执行</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>pluginName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span>callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// dosomething</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> CompressAssetsPlugin<span class="token punctuation">;</span>
</code></pre></div><p>通过 tapAsync 注册的事件函数中接受两个参数:</p> <ul><li>第一个参数为 compilation 对象表示本次构建的相关对象</li> <li>callback 参数对应我们通过 tapAsync 注册的异步事件函数，当调用 callback() 时表示注册事件执行完成。</li></ul> <h3 id="完善"><a href="#完善" class="header-anchor">#</a> 完善</h3> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">const</span> JSZip <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'jszip'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> RawSource <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'webpack-sources'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/* 
  将本次打包的资源都打包成为一个压缩包
  需求:获取所有打包后的资源
*/</span>
 
<span class="token keyword">const</span> pluginName <span class="token operator">=</span> <span class="token string">'CompressAssetsPlugin'</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">CompressAssetsPlugin</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> output <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>output <span class="token operator">=</span> output<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">apply</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// AsyncSeriesHook 将 assets 输出到 output 目录之前调用该钩子</span>
    compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>emit<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>pluginName<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 创建zip对象</span>
      <span class="token keyword">const</span> zip <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSZip</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 获取本次打包生成所有的assets资源</span>
      <span class="token keyword">const</span> assets <span class="token operator">=</span> compilation<span class="token punctuation">.</span><span class="token function">getAssets</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 循环每一个资源</span>
      assets<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> name<span class="token punctuation">,</span> source <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 调用source()方法获得对应的源代码 这是一个源代码的字符串</span>
        <span class="token keyword">const</span> sourceCode <span class="token operator">=</span> source<span class="token punctuation">.</span><span class="token function">source</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 往 zip 对象中添加资源名称和源代码内容</span>
        zip<span class="token punctuation">.</span><span class="token function">file</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> sourceCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 调用 zip.generateAsync 生成 zip 压缩包</span>
      zip<span class="token punctuation">.</span><span class="token function">generateAsync</span><span class="token punctuation">(</span><span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token string">'nodebuffer'</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token comment">// 通过 new RawSource 创建压缩包</span>
        <span class="token comment">// 并且同时通过 compilation.emitAsset 方法将生成的 Zip 压缩包输出到 this.output</span>
        compilation<span class="token punctuation">.</span><span class="token function">emitAsset</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>output<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">RawSource</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 调用 callback 表示本次事件函数结束</span>
        <span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> CompressAssetsPlugin<span class="token punctuation">;</span>
</code></pre></div><h2 id="webpack全流程"><a href="#webpack全流程" class="header-anchor">#</a> Webpack全流程</h2> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642595338751-dd4a709f-bdce-45eb-b412-c8ad1b9e7305.webp" alt="img"></p> <ol><li>初始化参数阶段</li></ol> <p>这一步会从我们配置的<code>webpack.config.js</code>中读取对应的配置参数和<code>shell</code>命令中传入的参数进行合并,得到最终打包的配置参数</p> <ol><li>开始编译准备阶段</li></ol> <p>这一步会通过调用<code>webpack()</code>方法返回一个<code>compiler</code>方法,创建<code>compiler</code>对象,并且注册各个<code>Plugin</code>.找到配置入口的<code>entry</code>代码,调用<code>compiler.run()</code>进行编译</p> <ol><li>模块编译阶段</li></ol> <p>从入口模块进行分析,调用匹配的<code>loader</code>对文件进行处理.同时分析模块的依赖,递归进行模块编译工作</p> <ol><li>完成编译阶段</li></ol> <p>使用<code>loader</code>翻译完所有模块后,得到每个模块被翻译后的最终内容以及他们直接的依赖关系</p> <ol><li>输出文件阶段</li></ol> <p>根据入口和模块之间的依赖关系,组装成一个一个包含多个模块的chunk,再把每个chunk转换成一个单独的文件加入到输出列表中.最后确定输出内容后,根据配置的路径和文件名写到文件系统</p> <p><strong>简单回答</strong></p> <ul><li><p>初始化：启动构建，读取与合并配置参数，加载 Plugin，实例化 Compiler</p></li> <li><p>编译：从 Entry 出发，针对每个 Module 串行调用对应的 Loader 去翻译文件的内容，再找到该 Module 依赖的 Module，递归地进行编译处理</p></li> <li><p>输出：将编译后的 Module 组合成 Chunk，将 Chunk 转换成文件，输出到文件系统中</p></li></ul> <h2 id="hmr"><a href="#hmr" class="header-anchor">#</a> HMR</h2> <h3 id="概念-3"><a href="#概念-3" class="header-anchor">#</a> 概念</h3> <p><strong>HMR即模块热更新.</strong></p> <p>刷新分为两种:一种是页面刷新,不保留状态,简单粗暴;另一种是基于<code>webpack-dev-server</code>的模块热替换,只需要局部刷新页面上变化的模块,同时保留当前页面状态,比如复选框的选中状态 输入框的输入等</p> <h3 id="使用方式"><a href="#使用方式" class="header-anchor">#</a> 使用方式</h3> <p>在<code>webpack</code>的配置文件中,将<code>deServer</code>的<code>hot</code>开启</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token operator">+</span> devServer<span class="token operator">:</span> <span class="token punctuation">{</span>
<span class="token operator">+</span>  hot<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>   <span class="token comment">// 启动模块热更新 HMR</span>
<span class="token operator">+</span>   open<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">// 开启自动打开浏览器页面</span>
<span class="token operator">+</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>在入口文件使用<code>module.hot</code>监听待更新的模块</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token string">'./library.js'</span><span class="token punctuation">,</span> <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 使用更新过的 library 模块执行某些操作...</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>webpack5</code>中不需要再继续手动的<code>HotModuleReplacementPlugin</code>插件配置,开启hot之后会自动配置,同时要在配置文件中把<code>target</code>设置为<code>web</code>.</p> <p>配置完成之后就可以在浏览器的控制台看见</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/png/22799595/1642734280051-26646a67-8a4d-4a29-bb25-eb837a34877a.png" alt="img"></p> <h3 id="webpack构建"><a href="#webpack构建" class="header-anchor">#</a> webpack构建</h3> <p>项目启动之后,会进行首次构建打包,控制台会输出整个构建的过程,可以观察到一个hash值</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642734500354-072b19b5-0ec4-484e-88cc-6e8d97dc7852.webp" alt="img"></p> <p>在每次代码的修改之后,保存时都会在控制台上出现<code>compiling</code>字样,可以在控制台观察到:</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642734611831-aea92463-c20d-4a41-9663-1fd5915de490.webp" alt="img"></p> <ul><li><p>Hash值更新</p></li> <li><p>生成了<code>hot-update.json</code></p></li> <li><p>生成了<code>hot-update.js</code></p></li></ul> <p>如果没有任何改动,则不会输出以上的新文件,Hash值也不会改变</p> <p>再次修改代码保存.可以观察到上次输出的Hash值被作为本次编译新生成的HMR文件标识</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642734662860-89ceb00f-9c6d-4307-a4f6-6a16a93b63a7.webp" alt="img"></p> <h3 id="实现原理"><a href="#实现原理" class="header-anchor">#</a> 实现原理</h3> <h4 id="注入"><a href="#注入" class="header-anchor">#</a> 注入</h4> <p>执行<code>npx webpack server</code>命令后,WDS调用<code>HotModuleReplacementPlugin</code>插件向应用的主Chunk注入一系列HMR Runtime:</p> <ul><li><p>用于建立WebSocket连接</p></li> <li><p>初始化<code>**RuntimeGlobals.hmrDownloadManifest**</code>和<code>**RuntimeGlobals.hmrDownloadUpdateHandlers**</code>接口</p></li> <li><p>初始化<code>**module.hot.accept**</code>接口</p></li></ul> <h4 id="增量构建"><a href="#增量构建" class="header-anchor">#</a> 增量构建</h4> <p><code>HotModuleReplacementPlugin</code>插件借助Webpack的watch能力,在代码文件发生变化后执行增量构建,生成:</p> <ul><li>mainfest文件:JSON格式文件,包含所有发生变更的模块列表</li> <li>模块变更文件:js格式,包含编译后的模块代码</li></ul> <p>增量构建完毕后,Webpack将触发<code>compilation.hooks.done</code>钩子.</p> <p>WDS监听<code>done</code>钩子,在回调中通过WebSocket发生模块更新消息</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642735281611-1b7d0f81-12c9-4333-b3be-baf6e0cbf6fa.webp" alt="img"></p> <h4 id="加载更新"><a href="#加载更新" class="header-anchor">#</a> 加载更新</h4> <p>客户端接收到hash消息后,发出<code>mainfest</code>请求获取本轮热更新涉及的chunk</p> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642735384150-bd5df0e3-fea6-46d2-a506-91d358bebebf.webp" alt="img"></p> <p>注意，在 Webpack 4 及之前，热更新文件以模块为单位，即所有发生变化的模块都会生成对应的热更新文件； Webpack 5 之后热更新文件以 chunk 为单位，如上例中，main chunk 下任意文件的变化都只会生成 main.[hash].hot-update.js 更新文件。</p> <p><code>mainfest</code>请求完毕后,客户端HMR运行时开始下载发生变化的chunk文件,将最新的模块代码加载到本地</p> <h4 id="module-hot-accept回调"><a href="#module-hot-accept回调" class="header-anchor">#</a> module.hot.accept回调</h4> <p>浏览器加载最新模块代码后,HMR运行时继续触发<code>module.hot.accept</code>回调,将最新代码替换到运行环境中</p> <h4 id="总结-5"><a href="#总结-5" class="header-anchor">#</a> 总结</h4> <ul><li><p>使用WDS托管资源,同时注入HMR客户端代码</p></li> <li><p>浏览器加载页面后,与WDS建立WS连接</p></li> <li><p>Webpack监听到文件变化后,增量构建变更的模块,通过WS发送hash事件</p></li> <li><p>浏览器接收到hash事件后,请求manifest资源文件,确定增量变更的范围</p></li> <li><p>浏览器加载变更的模块</p></li> <li><p>触发accept回调,执行代码变更逻辑</p></li> <li><p>done</p></li></ul> <p><img src="https://cdn.nlark.com/yuque/0/2022/webp/22799595/1642735672435-c31ff651-cf1f-48ff-8da9-423cc081f531.webp" alt="img"></p> <h2 id="tree-shaking"><a href="#tree-shaking" class="header-anchor">#</a> Tree Shaking</h2> <h3 id="概念-4"><a href="#概念-4" class="header-anchor">#</a> 概念</h3> <p>Tree Shaking是一种基于ES Module规范的Dead Code Elimination技术，它会在运行过程中静态分析模块之间的导入导出，确定ESM模块中哪些导出值未曾被其他模块使用，并将其删除，以此实现打包产物的优化</p> <h3 id="启动"><a href="#启动" class="header-anchor">#</a> 启动</h3> <p><strong>Tree Shaking只支持ESM的引入方式，不支持Common JS的引入方式。</strong></p> <p>如果要对一段代码做Tree Shaking处理，那么就要避免引入整个库到一个JS对象上，如果这么做了，Webpack就会认为你是需要这整个库的，这样就不会做Tree Shaking处理。</p> <p>下面是引入lodash的例子，如果引入的是lodash中的一部分，则可以Tree Shaking</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// Import everything (NOT TREE-SHAKABLE)</span>
<span class="token keyword">import</span> _ <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>

<span class="token comment">// Import named export (CAN BE TREE SHAKEN)</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> debounce <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'lodash'</span><span class="token punctuation">;</span>

<span class="token comment">// Import the item directly (CAN BE TREE SHAKEN)</span>
<span class="token keyword">import</span> debounce <span class="token keyword">from</span> <span class="token string">'lodash/lib/debounce'</span><span class="token punctuation">;</span>
</code></pre></div><p>在Webpack中启动，需要满足三个条件：</p> <ul><li><p>使用ESM规范编写模块代码</p></li> <li><p>配置<code>optimization.usedExports</code>为<code>true</code>，开启标记功能</p></li> <li><p>启动代码优化功能，可以通过如下方式实现：</p></li> <li><ul><li>配置mode=production,生产环境下默认启动Tree Shaking配置</li> <li>配置optimization.minimize=true</li></ul></li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// webpack.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry<span class="token operator">:</span> <span class="token string">&quot;./src/index&quot;</span><span class="token punctuation">,</span>
  mode<span class="token operator">:</span> <span class="token string">&quot;production&quot;</span><span class="token punctuation">,</span>
  devtool<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
  optimization<span class="token operator">:</span> <span class="token punctuation">{</span>
    usedExports<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="示例"><a href="#示例" class="header-anchor">#</a> 示例</h3> <p>对于下述代码</p> <div class="language-javascript extra-class"><pre class="language-javascript"><code><span class="token comment">// index.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>bar<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./bar'</span><span class="token punctuation">;</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>bar<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// bar.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> bar <span class="token operator">=</span> <span class="token string">'bar'</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> foo <span class="token operator">=</span> <span class="token string">'foo'</span><span class="token punctuation">;</span>
</code></pre></div><p>示例中，bar.js模块导出了bar foo，但只有bar导出值被其他模块使用，经过Tree Shaking处理后，foo变量会被视作无用代码删除</p> <h3 id="原理"><a href="#原理" class="header-anchor">#</a> 原理</h3> <p>Webpack中，Tree-shaking的实现是先通过<code>标记</code>出模块导出值中哪些值没有被使用过，然后通过<code>Terser</code>删掉这些没有被用过的导出语句</p> <p>标记过程分为三个步骤</p> <ul><li><p>编译（Make）阶段，收集模块导出变量并记录到模块依赖关系图ModuleGraph变量中</p></li> <li><p>输出资源（Seal）阶段，遍历ModuleGraph标记模块导出变量有没有被使用</p></li> <li><p>生成产物时，若变量没有被其他模块使用则删除对应的导出语句</p></li></ul></div></article> <div class="main-div vssue"><!----></div></div></main> <aside class="aside" data-v-b3fda33c data-v-b3fda33c><div class="info-card main-div" data-v-1311ce9e data-v-b3fda33c><div class="info-card-header" style="background-size:cover;background-repeat:no-repeat;background-position:center;background-attachment:scroll;background-image:url(/bg2.jpg);" data-v-1311ce9e><img src="/avatar-top.jpeg" alt="RunHio" class="info-avatar" data-v-1311ce9e></div> <div class="info-card-body" data-v-1311ce9e><section class="info-name" data-v-1311ce9e>
      RunHio
    </section> <section class="info-desc" data-v-1311ce9e>Record Growth</section> <section class="info-contact" data-v-1311ce9e><section data-v-1311ce9e><span data-v-1311ce9e data-v-1311ce9e><svg class="icon" style="font-size:1em;" data-v-1311ce9e data-v-1311ce9e><use xlink:href="#icon-location" data-v-1311ce9e data-v-1311ce9e></use></svg><span class="info-text" data-v-1311ce9e data-v-1311ce9e>
          Guangzhou, China
        </span></span></section> <!----> <section data-v-1311ce9e><span data-v-1311ce9e data-v-1311ce9e><svg class="icon" style="font-size:1em;" data-v-1311ce9e data-v-1311ce9e><use xlink:href="#icon-email" data-v-1311ce9e data-v-1311ce9e></use></svg><span class="info-text" data-v-1311ce9e data-v-1311ce9e>
          1056333479@qq.com
        </span></span></section></section></div> <div class="info-card-footer" data-v-1311ce9e><p class="footer-sns-link" data-v-1311ce9e><a target="_blank" class="sns-link" data-v-1311ce9e><span class="sns-icon" data-v-1311ce9e data-v-1311ce9e><svg class="icon" style="font-size:35px;" data-v-1311ce9e data-v-1311ce9e><use xlink:href="#icon-csdn" data-v-1311ce9e data-v-1311ce9e></use></svg></span></a><a target="_blank" class="sns-link" data-v-1311ce9e><span class="sns-icon" data-v-1311ce9e data-v-1311ce9e><svg class="icon" style="font-size:35px;" data-v-1311ce9e data-v-1311ce9e><use xlink:href="#icon-weibo" data-v-1311ce9e data-v-1311ce9e></use></svg></span></a><a target="_blank" class="sns-link" data-v-1311ce9e><span class="sns-icon" data-v-1311ce9e data-v-1311ce9e><svg class="icon" style="font-size:35px;" data-v-1311ce9e data-v-1311ce9e><use xlink:href="#icon-juejin" data-v-1311ce9e data-v-1311ce9e></use></svg></span></a><a target="_blank" class="sns-link" data-v-1311ce9e><span class="sns-icon" data-v-1311ce9e data-v-1311ce9e><svg class="icon" style="font-size:35px;" data-v-1311ce9e data-v-1311ce9e><use xlink:href="#icon-zhihu" data-v-1311ce9e data-v-1311ce9e></use></svg></span></a><a target="_blank" class="sns-link" data-v-1311ce9e><span class="sns-icon" data-v-1311ce9e data-v-1311ce9e><svg class="icon" style="font-size:35px;" data-v-1311ce9e data-v-1311ce9e><use xlink:href="#icon-github" data-v-1311ce9e data-v-1311ce9e></use></svg></span></a></p></div></div> <div class="post-toc main-div aside-toc" style="position:relative;top:0;width:0px;" data-v-b3fda33c><h4>- CATALOG</h4> <div class="post-nav-toc"><ul><li><a href="/posts/2022/01/23/webpack.html#模块化">模块化</a><ul><li><a href="/posts/2022/01/23/webpack.html#概念">概念</a></li><li><a href="/posts/2022/01/23/webpack.html#作用">作用</a></li><li><a href="/posts/2022/01/23/webpack.html#commonjs">CommonJS</a></li><li><a href="/posts/2022/01/23/webpack.html#amd和require-js">AMD和require.js</a></li><li><a href="/posts/2022/01/23/webpack.html#cmd和sea-js">CMD和sea.js</a></li><li><a href="/posts/2022/01/23/webpack.html#esm">ESM</a></li><li><a href="/posts/2022/01/23/webpack.html#esm和commonjs">ESM和CommonJS</a></li></ul></li><li><a href="/posts/2022/01/23/webpack.html#基础配置">基础配置</a><ul><li><a href="/posts/2022/01/23/webpack.html#简单配置">简单配置</a></li><li><a href="/posts/2022/01/23/webpack.html#优化构建速度">优化构建速度</a></li><li><a href="/posts/2022/01/23/webpack.html#优化构建结果">优化构建结果</a></li></ul></li><li><a href="/posts/2022/01/23/webpack.html#module-chunk-bundle区别">module,chunk,bundle区别</a><ul><li><a href="/posts/2022/01/23/webpack.html#总结-2">总结</a></li></ul></li><li><a href="/posts/2022/01/23/webpack.html#loader-2">loader</a><ul><li><a href="/posts/2022/01/23/webpack.html#概念-2">概念</a></li><li><a href="/posts/2022/01/23/webpack.html#基础配置参数">基础配置参数</a></li><li><a href="/posts/2022/01/23/webpack.html#loader的路径">loader的路径</a></li><li><a href="/posts/2022/01/23/webpack.html#loader种类">Loader种类</a></li><li><a href="/posts/2022/01/23/webpack.html#loader的执行顺序">Loader的执行顺序</a></li><li><a href="/posts/2022/01/23/webpack.html#pitch-loader">pitch-loader</a></li><li><a href="/posts/2022/01/23/webpack.html#normal-loader-pitch-loader参数">normal loader &amp; pitch loader参数</a></li></ul></li><li><a href="/posts/2022/01/23/webpack.html#自定义loader">自定义loader</a><ul><li><a href="/posts/2022/01/23/webpack.html#去除打印信息">去除打印信息</a></li><li><a href="/posts/2022/01/23/webpack.html#babel-loader">babel-loader</a></li></ul></li><li><a href="/posts/2022/01/23/webpack.html#tapable">Tapable</a></li><li><a href="/posts/2022/01/23/webpack.html#plugin-2">Plugin</a><ul><li><a href="/posts/2022/01/23/webpack.html#常用的对象">常用的对象</a></li><li><a href="/posts/2022/01/23/webpack.html#基本构成">基本构成</a></li><li><a href="/posts/2022/01/23/webpack.html#插件的构建对象">插件的构建对象</a></li><li><a href="/posts/2022/01/23/webpack.html#总结-4">总结</a></li></ul></li><li><a href="/posts/2022/01/23/webpack.html#自定义plugin">自定义plugin</a><ul><li><a href="/posts/2022/01/23/webpack.html#需求分析">需求分析</a></li><li><a href="/posts/2022/01/23/webpack.html#webpack配置">webpack配置</a></li><li><a href="/posts/2022/01/23/webpack.html#原理分析">原理分析</a></li><li><a href="/posts/2022/01/23/webpack.html#基础内容">基础内容</a></li><li><a href="/posts/2022/01/23/webpack.html#完善">完善</a></li></ul></li><li><a href="/posts/2022/01/23/webpack.html#webpack全流程">Webpack全流程</a></li><li><a href="/posts/2022/01/23/webpack.html#hmr">HMR</a><ul><li><a href="/posts/2022/01/23/webpack.html#概念-3">概念</a></li><li><a href="/posts/2022/01/23/webpack.html#使用方式">使用方式</a></li><li><a href="/posts/2022/01/23/webpack.html#webpack构建">webpack构建</a></li><li><a href="/posts/2022/01/23/webpack.html#实现原理">实现原理</a></li></ul></li><li><a href="/posts/2022/01/23/webpack.html#tree-shaking">Tree Shaking</a><ul><li><a href="/posts/2022/01/23/webpack.html#概念-4">概念</a></li><li><a href="/posts/2022/01/23/webpack.html#启动">启动</a></li><li><a href="/posts/2022/01/23/webpack.html#示例">示例</a></li><li><a href="/posts/2022/01/23/webpack.html#原理">原理</a></li></ul></li></ul></div></div></aside></div> <footer class="footer" data-v-7f2e4136><p class="footer-sns-link"><a target="_blank" class="sns-link"><span class="sns-icon"><svg class="icon" style="font-size:40px;"><use xlink:href="#icon-csdn"></use></svg></span></a><a target="_blank" class="sns-link"><span class="sns-icon"><svg class="icon" style="font-size:40px;"><use xlink:href="#icon-weibo"></use></svg></span></a><a target="_blank" class="sns-link"><span class="sns-icon"><svg class="icon" style="font-size:40px;"><use xlink:href="#icon-juejin"></use></svg></span></a><a target="_blank" class="sns-link"><span class="sns-icon"><svg class="icon" style="font-size:40px;"><use xlink:href="#icon-zhihu"></use></svg></span></a><a target="_blank" class="sns-link"><span class="sns-icon"><svg class="icon" style="font-size:40px;"><use xlink:href="#icon-github"></use></svg></span></a></p> <div class="copyright"><span id="custom">Copyright &copy; RunHio Blog 2021 <br /> </span> <!----></div></footer></div><div class="global-ui"><!----><!----></div></div>
    <script src="/assets/js/app.70cbfe2c.js" defer></script><script src="/assets/js/6.1419a14d.js" defer></script><script src="/assets/js/37.05db4cc6.js" defer></script>
  </body>
</html>